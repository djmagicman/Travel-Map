<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Travel Map</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-sA+4CsGhIG4jK6dsjz8kEGyWQC8nh+p3U5P+2KnkZKw="
    crossorigin=""
  />
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif;
      display: flex;
      overflow: hidden;
    }
    #sidebar {
      width: 250px;
      background: #2c3e50;
      color: white;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }
    #sidebar h2 {
      margin-top: 0;
      margin-bottom: 20px;
      font-weight: normal;
      font-size: 24px;
      border-bottom: 1px solid #34495e;
      padding-bottom: 10px;
    }
    #sidebar button {
      background: none;
      border: none;
      color: white;
      padding: 12px 10px;
      margin-bottom: 10px;
      font-size: 16px;
      cursor: pointer;
      text-align: left;
      border-radius: 4px;
      transition: background 0.3s;
    }
    #sidebar button:hover {
      background: #34495e;
    }
    #map {
      flex-grow: 1;
      height: 100vh;
      z-index: 0;
    }
    /* Формы и модалки */
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.3);
      transform: translate(-50%, -50%);
      max-width: 400px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      display: none;
      z-index: 1000;
    }
    .modal h3 {
      margin-top: 0;
    }
    .modal label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    .modal input[type="text"],
    .modal input[type="date"],
    .modal input[type="number"],
    .modal input[type="email"],
    .modal select,
    .modal textarea {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      resize: vertical;
    }
    .modal textarea {
      height: 60px;
    }
    .modal button {
      margin-top: 15px;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    .btn-primary {
      background-color: #2980b9;
      color: white;
      margin-right: 10px;
    }
    .btn-danger {
      background-color: #c0392b;
      color: white;
    }
    .btn-secondary {
      background-color: #7f8c8d;
      color: white;
    }
    #mediaPreview img,
    #mediaPreview video {
      max-width: 100%;
      margin-top: 10px;
      border-radius: 4px;
      display: block;
    }
    /* Список друзей */
    #friendsList div {
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }
    #loginSection {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: #ecf0f1;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 2000;
    }
    #loginSection input, #loginSection button {
      padding: 10px;
      margin: 5px 0;
      width: 250px;
      font-size: 16px;
    }
  </style>
</head>
<body>

  <div id="sidebar">
    <h2>Travel Map</h2>
    <button id="profileBtn">Профиль</button>
    <button id="friendsBtn">Друзья</button>
    <button id="logoutBtn">Выйти</button>
  </div>

  <div id="map"></div>

  <!-- Форма метки (поездки) -->
  <div id="form" class="modal">
    <h3>Добавить / Редактировать поездку</h3>
    <div id="coordDisplay"></div>
    <div id="addressDisplay" style="font-style: italic; color: #555;"></div>

    <label for="placeName">Название места</label>
    <input type="text" id="placeName" />

    <label for="visitDate">Дата посещения</label>
    <input type="date" id="visitDate" />

    <label for="markerType">Тип метки</label>
    <select id="markerType">
      <option value="visited">Посещённое</option>
      <option value="planned">Планируемое</option>
    </select>

    <label for="markerColor">Цвет метки</label>
    <select id="markerColor">
      <option value="red">Красный</option>
      <option value="blue">Синий</option>
      <option value="green">Зелёный</option>
      <option value="orange">Оранжевый</option>
    </select>

    <label for="comment">Комментарий</label>
    <textarea id="comment"></textarea>

    <label for="mediaInput">Фото/Видео (можно несколько)</label>
    <input type="file" id="mediaInput" accept="image/*,video/*" multiple />

    <div id="mediaPreview"></div>

    <button id="saveMarkerBtn" class="btn-primary">Сохранить</button>
    <button id="deleteMarkerBtn" class="btn-danger">Удалить</button>
    <button id="cancelMarkerBtn" class="btn-secondary">Отмена</button>
  </div>

  <!-- Профиль -->
  <div id="profile" class="modal">
    <h3>Профиль</h3>
    <label for="profileName">Имя</label>
    <input type="text" id="profileName" />

    <label for="profileAge">Возраст</label>
    <input type="number" id="profileAge" min="1" max="120" />

    <label for="profileComment">Комментарий</label>
    <textarea id="profileComment"></textarea>

    <button id="saveProfileBtn" class="btn-primary">Сохранить</button>
    <button id="cancelProfileBtn" class="btn-secondary">Отмена</button>
  </div>

  <!-- Друзья -->
  <div id="friends" class="modal" style="max-width: 500px;">
    <h3>Друзья</h3>
    <input type="email" id="friendEmailInput" placeholder="Email друга" />
    <button id="addFriendBtn" class="btn-primary" style="margin-bottom:10px;">Добавить друга</button>
    <div id="friendsList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc; border-radius: 4px; padding: 5px;"></div>
    <button id="closeFriendsBtn" class="btn-secondary" style="margin-top: 15px;">Закрыть</button>
  </div>

  <!-- Логин -->
  <div id="loginSection">
    <h2>Вход в систему</h2>
    <input type="email" id="loginEmail" placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Пароль" />
    <button id="loginBtn">Войти</button>
    <button id="registerBtn">Регистрация</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-o9N1j6k7M/q7gzH/3hCz5pWc2uExlHAt0UoxZToHQuY="
    crossorigin=""></script>

  <!-- Firebase SDK -->
  <script type="module">
    // Импорт Firebase из CDN (ESM)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      getDoc,
      getDocs,
      addDoc,
      query,
      where,
      updateDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

    // Конфиг Firebase - Вставь свои данные сюда:
    const firebaseConfig = {
      apiKey: "AIzaSyB0c7llONI831LKFmqTIH6393ZD4ZjBOZY",
      authDomain: "travel-map-f3677.firebaseapp.com",
      projectId: "travel-map-f3677",
      storageBucket: "travel-map-f3677.appspot.com",
      messagingSenderId: "692883514599",
      appId: "1:692883514599:web:0b7a71587433e67a85ae42",
      measurementId: "G-M8L8K1DL29"
    };

    // Инициализация Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Глобальные переменные
    let map;
    let currentUser = null;
    let currentUserData = null;
    let currentLatLng = null;
    let currentEditId = null;
    let leafletMarkers = [];

    // Инициализация карты
    function initMap() {
      map = L.map('map').setView([55.7558, 37.6173], 6);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      map.on('click', onMapClick);
    }

    // Обработчик клика по карте
    function onMapClick(e) {
      currentLatLng = e.latlng;
      openMarkerForm();
    }

    // Открыть форму добавления/редактирования метки
    function openMarkerForm(data) {
      document.getElementById('form').style.display = 'block';

      document.getElementById('coordDisplay').textContent = `Координаты: ${currentLatLng.lat.toFixed(5)}, ${currentLatLng.lng.toFixed(5)}`;

      if (data) {
        currentEditId = data.id;
        document.getElementById('placeName').value = data.placeName || '';
        document.getElementById('visitDate').value = data.visitDate || '';
        document.getElementById('markerType').value = data.markerType || 'visited';
        document.getElementById('markerColor').value = data.markerColor || 'red';
        document.getElementById('comment').value = data.comment || '';
        currentLatLng = L.latLng(data.lat, data.lng);
        loadMediaPreview(data.mediaUrls || []);
        document.getElementById('deleteMarkerBtn').style.display = 'inline-block';
      } else {
        currentEditId = null;
        document.getElementById('placeName').value = '';
        document.getElementById('visitDate').value = '';
        document.getElementById('markerType').value = 'visited';
        document.getElementById('markerColor').value = 'red';
        document.getElementById('comment').value = '';
        document.getElementById('mediaInput').value = '';
        document.getElementById('mediaPreview').innerHTML = '';
        document.getElementById('deleteMarkerBtn').style.display = 'none';
      }
    }

    // Закрыть форму метки
    function closeMarkerForm() {
      document.getElementById('form').style.display = 'none';
      currentEditId = null;
      currentLatLng = null;
    }

    // Загрузить медиа-превью (фото/видео)
    function loadMediaPreview(urls) {
      const preview = document.getElementById('mediaPreview');
      preview.innerHTML = '';
      urls.forEach(url => {
        if (url.match(/\.(mp4|webm|ogg)$/)) {
          const video = document.createElement('video');
          video.src = url;
          video.controls = true;
          preview.appendChild(video);
        } else {
          const img = document.createElement('img');
          img.src = url;
          preview.appendChild(img);
        }
      });
    }

    // Сохранить метку (поездку)
    async function saveMarker() {
      if (!currentUser) return alert('Пользователь не авторизован');
      if (!currentLatLng) return alert('Нет координат');

      const placeName = document.getElementById('placeName').value.trim();
      const visitDate = document.getElementById('visitDate').value;
      const markerType = document.getElementById('markerType').value;
      const markerColor = document.getElementById('markerColor').value;
      const comment = document.getElementById('comment').value.trim();
      const mediaFiles = document.getElementById('mediaInput').files;

      if (!placeName) return alert('Введите название места');

      // Загружаем файлы медиа в Firebase Storage
      const mediaUrls = [];
      if (mediaFiles.length > 0) {
        for (let i = 0; i < mediaFiles.length; i++) {
          const file = mediaFiles[i];
          const storageRef = ref(storage, `users/${currentUser.uid}/media/${Date.now()}_${file.name}`);
          try {
            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);
            mediaUrls.push(url);
          } catch (err) {
            console.error('Ошибка загрузки файла:', err);
          }
        }
      }

      // Если редактируем - обновляем документ, иначе добавляем новый
      if (currentEditId) {
        const markerDocRef = doc(db, 'users', currentUser.uid, 'trips', currentEditId);
        await updateDoc(markerDocRef, {
          placeName,
          visitDate,
          markerType,
          markerColor,
          comment,
          lat: currentLatLng.lat,
          lng: currentLatLng.lng,
          // если есть новые медиа, добавим их, иначе оставим старые
          mediaUrls: mediaUrls.length > 0 ? mediaUrls : currentUserData.trips?.find(t => t.id === currentEditId)?.mediaUrls || []
        });
      } else {
        const tripsCollection = collection(db, 'users', currentUser.uid, 'trips');
        await addDoc(tripsCollection, {
          placeName,
          visitDate,
          markerType,
          markerColor,
          comment,
          lat: currentLatLng.lat,
          lng: currentLatLng.lng,
          mediaUrls
        });
      }

      closeMarkerForm();
      loadMarkersFromFirestore();
    }

    // Удалить метку
    async function deleteMarker() {
      if (!currentEditId) return;
      if (!confirm('Удалить эту поездку?')) return;

      const markerDocRef = doc(db, 'users', currentUser.uid, 'trips', currentEditId);
      await deleteDoc(markerDocRef);

      closeMarkerForm();
      loadMarkersFromFirestore();
    }

    // Загрузить метки из Firestore и показать их на карте
    async function loadMarkersFromFirestore() {
      clearMarkers();

      if (!currentUser) return;

      const tripsCollection = collection(db, 'users', currentUser.uid, 'trips');
      const snapshot = await getDocs(tripsCollection);
      currentUserData = currentUserData || {};
      currentUserData.trips = [];

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;
        currentUserData.trips.push({ id, ...data });

        const marker = L.circleMarker([data.lat, data.lng], {
          color: data.markerColor || 'red',
          radius: 8
        }).addTo(map);

        marker.on('click', () => {
          currentLatLng = L.latLng(data.lat, data.lng);
          openMarkerForm({ id, ...data });
        });

        marker.bindPopup(`<b>${data.placeName}</b><br>${data.visitDate || ''}<br>${data.comment || ''}<br>` +
          (data.mediaUrls && data.mediaUrls.length > 0 ? data.mediaUrls.map(url => {
            if (url.match(/\.(mp4|webm|ogg)$/)) {
              return `<video src="${url}" controls width="150"></video>`;
            } else {
              return `<img src="${url}" width="150" style="border-radius:4px; margin-top:4px;" />`;
            }
          }).join('') : '')
        );

        leafletMarkers.push(marker);
      });
    }

    // Очистить все метки с карты
    function clearMarkers() {
      leafletMarkers.forEach(m => map.removeLayer(m));
      leafletMarkers = [];
    }

    // --- Профиль ---

    async function loadProfile() {
      if (!currentUser) return;
      const docRef = doc(db, 'users', currentUser.uid);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById('profileName').value = data.name || '';
        document.getElementById('profileAge').value = data.age || '';
        document.getElementById('profileComment').value = data.comment || '';
      } else {
        document.getElementById('profileName').value = '';
        document.getElementById('profileAge').value = '';
        document.getElementById('profileComment').value = '';
      }
    }

    async function saveProfile() {
      if (!currentUser) return;
      const name = document.getElementById('profileName').value.trim();
      const age = parseInt(document.getElementById('profileAge').value, 10);
      const comment = document.getElementById('profileComment').value.trim();

      await setDoc(doc(db, 'users', currentUser.uid), {
        name,
        age: isNaN(age) ? null : age,
        comment
      }, { merge: true });

      alert('Профиль сохранён');
      closeProfile();
    }

    function openProfile() {
      document.getElementById('profile').style.display = 'block';
      loadProfile();
    }

    function closeProfile() {
      document.getElementById('profile').style.display = 'none';
    }

    // --- Друзья ---

    async function loadFriends() {
      if (!currentUser) return;
      const friendsListElem = document.getElementById('friendsList');
      friendsListElem.innerHTML = '';

      const friendsCollection = collection(db, 'users', currentUser.uid, 'friends');
      const snapshot = await getDocs(friendsCollection);

      if (snapshot.empty) {
        friendsListElem.innerHTML = '<p>Список друзей пуст</p>';
        return;
      }

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement('div');
        div.textContent = data.name ? `${data.name} (${data.email})` : data.email;
        friendsListElem.appendChild(div);
      });
    }

    async function addFriend() {
      if (!currentUser) return alert('Сначала войдите');

      const email = document.getElementById('friendEmailInput').value.trim();
      if (!email) return alert('Введите email друга');

      // Ищем пользователя по email
      const usersRef = collection(db, 'users');
      const q = query(usersRef, where('email', '==', email));
      const querySnapshot = await getDocs(q);

      if (querySnapshot.empty) return alert('Пользователь с таким email не найден');

      const friendDoc = querySnapshot.docs[0];

      // Проверяем, не добавлен ли уже
      const friendDocRef = doc(db, 'users', currentUser.uid, 'friends', friendDoc.id);
      const friendSnap = await getDoc(friendDocRef);
      if (friendSnap.exists()) {
        return alert('Этот пользователь уже в друзьях');
      }

      // Добавляем друга
      await setDoc(friendDocRef, {
        email: email,
        name: friendDoc.data().name || ''
      });

      alert('Друг добавлен');
      document.getElementById('friendEmailInput').value = '';
      loadFriends();
    }

    function openFriends() {
      document.getElementById('friends').style.display = 'block';
      loadFriends();
    }
    function closeFriends() {
      document.getElementById('friends').style.display = 'none';
    }

    // --- АВТОРИЗАЦИЯ ---

    onAuthStateChanged(auth, user => {
      currentUser = user;
      if(user) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('sidebar').style.display = 'flex';
        document.getElementById('map').style.display = 'block';
        loadMarkersFromFirestore();
      } else {
        document.getElementById('loginSection').style.display = 'flex';
        document.getElementById('sidebar').style.display = 'none';
        document.getElementById('map').style.display = 'none';
        clearMarkers();
        closeProfile();
        closeFriends();
        closeMarkerForm();
      }
    });

    // Вход
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch(e) {
        alert('Ошибка входа: ' + e.message);
      }
    });

    // Регистрация
    document.getElementById('registerBtn').addEventListener('click', async () => {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        // После регистрации сохраняем email в профиль
        await setDoc(doc(db, 'users', userCredential.user.uid), { email });
        alert('Регистрация успешна. Войдите в систему.');
      } catch(e) {
        alert('Ошибка регистрации: ' + e.message);
      }
    });

    // Выход
    document.getElementById('logoutBtn').addEventListener('click', () => {
      signOut(auth);
    });

    // Кнопки меню
    document.getElementById('profileBtn').addEventListener('click', openProfile);
    document.getElementById('friendsBtn').addEventListener('click', openFriends);

    // Кнопки формы метки
    document.getElementById('saveMarkerBtn').addEventListener('click', saveMarker);
    document.getElementById('cancelMarkerBtn').addEventListener('click', closeMarkerForm);
    document.getElementById('deleteMarkerBtn').addEventListener('click', deleteMarker);

    // Кнопки профиля
    document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
    document.getElementById('cancelProfileBtn').addEventListener('click', closeProfile);

    // Кнопки друзей
    document.getElementById('addFriendBtn').addEventListener('click', addFriend);
    document.getElementById('closeFriendsBtn').addEventListener('click', closeFriends);

    // Инициализация карты после загрузки страницы
    window.onload = initMap;

  </script>
</body>
</html>
