<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Travel Map Social —Å –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
  #authContainer, #mainContainer { max-width: 400px; margin: 30px auto; }
  #mainContainer { display: none; height: 80vh; }
  #map { height: 60vh; margin-bottom: 10px; }
  input, button, select, textarea { display: block; width: 100%; margin: 6px 0; padding: 8px; font-size: 14px; box-sizing: border-box; }
  #logoutBtn { margin-top: 10px; background: #d9534f; color: white; border: none; cursor: pointer; }
  .form-popup, .profile-popup {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: white; padding: 10px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.2);
    z-index: 10000; width: 320px; display: none;
  }
  .media-preview img, .media-preview video { max-width: 100%; margin-top: 5px; }
  .marker-toggle {
    margin: 10px 0;
  }
  .chat-box {
    background: white; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.3);
    display: flex; flex-direction: column; height: 220px;
  }
  .chat-messages {
    flex: 1; overflow-y: auto; padding: 6px; font-size: 13px; border-bottom: 1px solid #ddd;
  }
  .chat-input {
    display: flex; border-top: 1px solid #ccc;
  }
  .chat-input input { flex: 1; border: none; padding: 8px; }
  .chat-input button {
    border: none; background: #2196f3; color: white; padding: 8px 12px; cursor: pointer;
  }
</style>
</head>
<body>

<!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
<div id="authContainer">
  <h2 id="authTitle">–í—Ö–æ–¥</h2>
  <input type="tel" id="phoneInput" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" />
  <input type="password" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å" />
  <button id="authBtn">–í–æ–π—Ç–∏</button>
  <div id="authMessage" style="color:red; min-height:20px;"></div>
  <div><a href="#" id="toggleAuth">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
<div id="mainContainer">
  <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="userPhone"></span>!</h3>
  <button id="logoutBtn">–í—ã–π—Ç–∏</button>

  <div id="map"></div>

  <div class="marker-toggle">
    <label><input type="checkbox" id="toggleVisited" checked /> –ë—ã–ª</label>
    <label><input type="checkbox" id="togglePlanned" checked /> –ü–ª–∞–Ω–∏—Ä—É—é</label>
  </div>

  <button onclick="toggleProfile()">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>

  <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Å—Ç–∞ -->
  <div class="form-popup" id="form">
    <input type="text" id="placeName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞" />
    <input type="date" id="visitDate" />
    <textarea id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
    <select id="markerType">
      <option value="visited">–ë—ã–ª –∑–¥–µ—Å—å</option>
      <option value="planned">–ü–ª–∞–Ω–∏—Ä—É—é –ø–æ–µ–∑–¥–∫—É</option>
    </select>
    <input type="file" id="mediaInput" accept="image/*,video/*" multiple />
    <div class="media-preview" id="mediaPreview"></div>
    <div id="coordDisplay"></div>
    <button onclick="saveMarker()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="closeForm()">–û—Ç–º–µ–Ω–∞</button>
  </div>

  <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
  <div class="profile-popup" id="profile">
    <b>–ü—Ä–æ—Ñ–∏–ª—å</b>
    <input type="text" id="username" placeholder="–ò–º—è" />
    <input type="number" id="userage" placeholder="–í–æ–∑—Ä–∞—Å—Ç" />
    <textarea id="userdesc" placeholder="–û —Å–µ–±–µ"></textarea>
    <button onclick="saveProfile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="toggleProfile()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>

  <!-- –ß–∞—Ç -->
  <div class="chat-box">
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
      <button onclick="sendMessage()">‚û§</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // --- –î–∞–Ω–Ω—ã–µ ---
  let users = JSON.parse(localStorage.getItem('users') || '[]');
  let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');

  // DOM
  const authContainer = document.getElementById('authContainer');
  const mainContainer = document.getElementById('mainContainer');
  const authTitle = document.getElementById('authTitle');
  const phoneInput = document.getElementById('phoneInput');
  const passwordInput = document.getElementById('passwordInput');
  const authBtn = document.getElementById('authBtn');
  const authMessage = document.getElementById('authMessage');
  const toggleAuth = document.getElementById('toggleAuth');
  const userPhoneSpan = document.getElementById('userPhone');
  const logoutBtn = document.getElementById('logoutBtn');

  // –§–æ—Ä–º–∞ –∏ –ø—Ä–æ—Ñ–∏–ª—å
  const form = document.getElementById('form');
  const profilePopup = document.getElementById('profile');

  const placeNameInput = document.getElementById('placeName');
  const visitDateInput = document.getElementById('visitDate');
  const commentInput = document.getElementById('comment');
  const markerTypeSelect = document.getElementById('markerType');
  const mediaInput = document.getElementById('mediaInput');
  const mediaPreview = document.getElementById('mediaPreview');
  const coordDisplay = document.getElementById('coordDisplay');

  // –ú–∞—Ä–∫–µ—Ä—ã –∏ –∫–∞—Ä—Ç–∞
  let map;
  let leafletMarkers = [];
  let currentLatLng = null;

  // –ß–∞—Ç
  let chat = [];

  // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  let isLogin = true;

  // --- –§—É–Ω–∫—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ---
  function showMain() {
    authContainer.style.display = 'none';
    mainContainer.style.display = 'block';
    userPhoneSpan.textContent = currentUser.phone;
    loadUserData();
    initMap();
    renderMarkers();
    renderChat();
  }

  function showAuth() {
    authContainer.style.display = 'block';
    mainContainer.style.display = 'none';
    authMessage.textContent = '';
    phoneInput.value = '';
    passwordInput.value = '';
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
  function initMap() {
    if (map) return;
    map = L.map('map').setView([55.75, 37.62], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    map.on('click', function(e) {
      currentLatLng = e.latlng;
      openForm();
    });

    // –§–∏–ª—å—Ç—Ä—ã
    document.getElementById('toggleVisited').addEventListener('change', renderMarkers);
    document.getElementById('togglePlanned').addEventListener('change', renderMarkers);
  }

  // –û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
  function openForm() {
    form.style.display = 'block';
    placeNameInput.value = '';
    visitDateInput.value = '';
    commentInput.value = '';
    markerTypeSelect.value = 'visited';
    mediaInput.value = '';
    mediaPreview.innerHTML = '';
    coordDisplay.textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${currentLatLng.lat.toFixed(5)}, ${currentLatLng.lng.toFixed(5)}`;
  }

  function closeForm() {
    form.style.display = 'none';
    currentLatLng = null;
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–≤—å—é –º–µ–¥–∏–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ
  mediaInput.addEventListener('change', () => {
    mediaPreview.innerHTML = '';
    Array.from(mediaInput.files).forEach(file => {
      const url = URL.createObjectURL(file);
      if (file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = url;
        mediaPreview.appendChild(img);
      } else if (file.type.startsWith('video/')) {
        const video = document.createElement('video');
        video.src = url;
        video.controls = true;
        mediaPreview.appendChild(video);
      }
    });
  });

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
  function saveMarker() {
    if (!placeNameInput.value.trim()) {
      alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞');
      return;
    }
    if (!currentLatLng) {
      alert('–û—à–∏–±–∫–∞ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏');
      return;
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–¥–∏–∞ –∫–∞–∫ base64 (—É–ø—Ä–æ—â–µ–Ω–Ω–æ –¥–ª—è demo)
    const files = mediaInput.files;
    let mediaData = [];

    if (files.length === 0) {
      saveMarkerData([]);
    } else {
      let loadedCount = 0;
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();
        reader.onload = function(e) {
          mediaData.push({ type: file.type, data: e.target.result });
          loadedCount++;
          if (loadedCount === files.length) {
            saveMarkerData(mediaData);
          }
        };
        reader.readAsDataURL(file);
      }
    }

    function saveMarkerData(media) {
      const newMarker = {
        id: Date.now(),
        name: placeNameInput.value.trim(),
        date: visitDateInput.value,
        comment: commentInput.value.trim(),
        type: markerTypeSelect.value,
        lat: currentLatLng.lat,
        lng: currentLatLng.lng,
        media: media
      };

      currentUser.markers.push(newMarker);
      saveCurrentUser();
      renderMarkers();
      closeForm();
    }
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤
  function renderMarkers() {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ
    leafletMarkers.forEach(m => map.removeLayer(m));
    leafletMarkers = [];

    if (!currentUser.markers) return;

    const showVisited = document.getElementById('toggleVisited').checked;
    const showPlanned = document.getElementById('togglePlanned').checked;

    currentUser.markers.forEach(marker => {
      if ((marker.type === 'visited' && !showVisited) || (marker.type === 'planned' && !showPlanned)) return;

      const icon = L.divIcon({
        className: 'custom-div-icon',
        html: marker.type === 'visited' ? 'üìç' : 'üìå',
        iconSize: [24, 24],
        iconAnchor: [12, 24],
      });

      const leafletMarker = L.marker([marker.lat, marker.lng], { icon }).addTo(map);

      let popupContent = `<b>${marker.name}</b><br>`;
      if (marker.date) popupContent += `–î–∞—Ç–∞: ${marker.date}<br>`;
      if (marker.comment) popupContent += `${marker.comment}<br>`;
      if (marker.media && marker.media.length > 0) {
        marker.media.forEach(m => {
          if (m.type.startsWith('image/')) {
            popupContent += `<img src="${m.data}" style="max-width:200px; display:block; margin-top:5px;" />`;
          } else if (m.type.startsWith('video/')) {
            popupContent += `<video src="${m.data}" controls style="max-width:200px; display:block; margin-top:5px;"></video>`;
          }
        });
      }
      leafletMarker.bindPopup(popupContent);
      leafletMarkers.push(leafletMarker);
    });
  }

  // --- –ü—Ä–æ—Ñ–∏–ª—å ---
  const usernameInput = document.getElementById('username');
  const userageInput = document.getElementById('userage');
  const userdescInput = document.getElementById('userdesc');

  function toggleProfile() {
    if (profilePopup.style.display === 'block') {
      profilePopup.style.display = 'none';
    } else {
      usernameInput.value = currentUser.profile?.name || '';
      userageInput.value = currentUser.profile?.age || '';
      userdescInput.value = currentUser.profile?.desc || '';
      profilePopup.style.display = 'block';
    }
  }

  function saveProfile() {
    currentUser.profile = {
      name: usernameInput.value.trim(),
      age: userageInput.value.trim(),
      desc: userdescInput.value.trim()
    };
    saveCurrentUser();
    alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
    toggleProfile();
  }

  // --- –ß–∞—Ç ---
  const chatMessagesDiv = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');

  function loadUserData() {
    if (!currentUser.markers) currentUser.markers = [];
    if (!currentUser.chat) currentUser.chat = [];
    chat = JSON.parse(localStorage.getItem('chat') || '[]');
  }

  function renderChat() {
    chatMessagesDiv.innerHTML = '';
    chat.forEach(msg => {
      const div = document.createElement('div');
      div.innerHTML = `<b>${msg.user}:</b> ${msg.text}`;
      chatMessagesDiv.appendChild(div);
    });
    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
  }

  function sendMessage() {
    const text = chatInput.value.trim();
    if (!text) return;
    const message = { user: currentUser.phone, text: text, time: Date.now() };
    chat.push(message);
    localStorage.setItem('chat', JSON.stringify(chat));
    chatInput.value = '';
    renderChat();
  }

  // --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ---

  authBtn.addEventListener('click', () => {
    const phone = phoneInput.value.trim();
    const password = passwordInput.value;

    if (!phone || !password) {
      authMessage.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –ø–∞—Ä–æ–ª—å';
      return;
    }

    if (isLogin) {
      // –í—Ö–æ–¥
      const user = users.find(u => u.phone === phone && u.password === password);
      if (!user) {
        authMessage.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
        return;
      }
      currentUser = user;
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      showMain();
    } else {
      // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
      if (users.find(u => u.phone === phone)) {
        authMessage.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
        return;
      }
      const newUser = {
        phone,
        password,
        markers: [],
        profile: {},
      };
      users.push(newUser);
      localStorage.setItem('users', JSON.stringify(users));
      currentUser = newUser;
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      showMain();
    }
  });

  toggleAuth.addEventListener('click', e => {
    e.preventDefault();
    isLogin = !isLogin;
    if (isLogin) {
      authTitle.textContent = '–í—Ö–æ–¥';
      authBtn.textContent = '–í–æ–π—Ç–∏';
      toggleAuth.textContent = '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
      authMessage.textContent = '';
    } else {
      authTitle.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
      authBtn.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
      toggleAuth.textContent = '–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏';
      authMessage.textContent = '';
    }
  });

  logoutBtn.addEventListener('click', () => {
    currentUser = null;
    localStorage.removeItem('currentUser');
    showAuth();
  });

  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ users –∏ localStorage
  function saveCurrentUser() {
    const idx = users.findIndex(u => u.phone === currentUser.phone);
    if (idx !== -1) {
      users[idx] = currentUser;
      localStorage.setItem('users', JSON.stringify(users));
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
    }
  }

  // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  if (currentUser) {
    showMain();
  } else {
    showAuth();
  }
</script>

</body>
</html>
