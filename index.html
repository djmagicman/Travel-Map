```html
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Travel Map с Firebase</title>

<!-- Google Fonts: Poppins for modern look -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300,400,600,700&display=swap" rel="stylesheet">
<!-- FontAwesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  /* Your previous styles here... */

  /* Additional styles for the profile modal */
  #profileModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--bg-dark);
    padding: 20px;
    z-index: 2000;
    display: none; /* Hidden by default */
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
  }
  
  #profileModal input, #profileModal button {
    margin: 10px 0;
    width: 100%;
  }

  #weatherInfo {
    position: absolute;
    top: 15px;
    right: 15px;
    background: var(--bg-dark);
    padding: 10px;
    border-radius: var(--border-radius);
    z-index: 1000;
    color: white;
  }
  
</style>
</head>
<body>

<div id="toggleControlsBtn">
    <i class="fas fa-bars"></i>
</div>

<div id="controls">
  <h2><i class="fas fa-map-marked-alt"></i> Travel Map</h2>
  <div id="userInfo"></div>
  <button id="loginBtn"><i class="fab fa-google"></i> Войти через Google</button>
  <button id="logoutBtn" style="display:none;"><i class="fas fa-sign-out-alt"></i> Выйти</button>
  <button id="profileBtn" style="display:none;"><i class="fas fa-user"></i> Профиль</button>

  <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

  <div class="autocomplete-container">
      <label for="cityInput">Введите город:</label>
      <input type="text" id="cityInput" autocomplete="off" placeholder="Например, Париж" />
      <div id="suggestions"></div>
  </div>

  <label for="colorInput">Цвет метки:</label>
  <input type="color" id="colorInput" value="#4CAF50" />

  <button id="addBtn">
      <span id="addBtnText"><i class="fas fa-plus-circle"></i> Добавить метку</span>
      <span id="addBtnLoader" class="loader"></span>
  </button>
</div>

<div id="map"></div>
<div id="weatherInfo"></div>
<div id="notification-container"></div>

<!-- Profile modal -->
<div id="profileModal">
  <h3>Ваш профиль</h3>
  <input type="text" id="nameInput" placeholder="Ваше имя" />
  <input type="number" id="ageInput" placeholder="Возраст" />
  <input type="text" id="factsInput" placeholder="Факты о себе" />
  <input type="file" id="avatarInput" />
  <button id="saveProfileBtn">Сохранить профиль</button>
  <button id="closeProfileModalBtn">Закрыть</button>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase SDK (v9 Modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    query,
    where,
    getDocs,
    updateDoc,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB0c7llONI831LKFmqTIH6393ZD4ZjBOZY",
    authDomain: "travel-map-f3677.firebaseapp.com",
    projectId: "travel-map-f3677",
    storageBucket: "travel-map-f3677.firebasestorage.app",
    messagingSenderId: "692883514599",
    appId: "1:692883514599:web:0b7a71587433e67a85ae42",
    measurementId: "G-M8L8K1DL29"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const userInfo = document.getElementById("userInfo");
  const cityInput = document.getElementById("cityInput");
  const colorInput = document.getElementById("colorInput");
  const addBtn = document.getElementById("addBtn");
  const addBtnLoader = document.getElementById("addBtnLoader");
  const suggestionsDiv = document.getElementById("suggestions");
  const toggleControlsBtn = document.getElementById("toggleControlsBtn");
  const notificationContainer = document.getElementById("notification-container");
  const profileModal = document.getElementById("profileModal");
  const profileBtn = document.getElementById("profileBtn");
  const nameInput = document.getElementById("nameInput");
  const ageInput = document.getElementById("ageInput");
  const factsInput = document.getElementById("factsInput");
  const avatarInput = document.getElementById("avatarInput");
  const saveProfileBtn = document.getElementById("saveProfileBtn");
  const closeProfileModalBtn = document.getElementById("closeProfileModalBtn");
  const weatherInfo = document.getElementById("weatherInfo");

  const map = L.map("map").setView([55.751244, 37.618423], 5);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "© OpenStreetMap"
  }).addTo(map);

  let markers = [];
  let selectedCity = null;
  let typingTimer;
  const doneTypingInterval = 500; // 0.5 seconds

  // Load markers for specific user when they log in
  async function loadUserMarkers(userId) {
    clearMarkers();
    const markersQuery = query(
      collection(db, "markers"),
      where("userId", "==", userId)
    );

    try {
        const querySnapshot = await getDocs(markersQuery);
        
        if (querySnapshot.empty) {
            showNotification("У вас пока нет меток. Добавьте первую!");
        }

        querySnapshot.forEach(docSnap => {
          const data = docSnap.data();
          const idDoc = docSnap.id;

          const marker = L.circleMarker([data.lat, data.lon], {
            color: data.color,
            radius: 8,
            fillOpacity: 0.7,
            weight: 2,
            opacity: 0.8
          }).addTo(map);

          marker.bindPopup(createPopupContent(data.cityName, data.color, idDoc, marker));
          markers.push({ idDoc, marker, data });
        });
        showNotification("Ваши метки загружены!");
    } catch (e) {
        showNotification("Ошибка при загрузке меток: " + e.message, true);
    }
  }

  // For displaying current weather
  async function displayWeather(lat, lon) {
    const apiKey = 'YOUR_WEATHER_API_KEY'; // Use your weather API key
    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&lang=ru&units=metric`;
    try {
      const response = await fetch(url);
      const data = await response.json();
      if (data && data.weather) {
        const mainWeather = data.weather[0].description;
        const temperature = data.main.temp;
        weatherInfo.innerHTML = `Погода: ${mainWeather}, ${temperature}°C`;
      }
    } catch (error) {
      console.error("Ошибка получения погоды:", error);
      weatherInfo.textContent = "Ошибка получения погоды.";
    }
  }

  // Add marker and display weather on click
  map.on('click', function(e) {
    displayWeather(e.latlng.lat, e.latlng.lng);
  });

  // Opening profile modal
  profileBtn.addEventListener("click", () => {
    profileModal.style.display = "block";
  });

  // Closing profile modal
  closeProfileModalBtn.addEventListener("click", () => {
    profileModal.style.display = "none";
  });

  // Save profile information
  saveProfileBtn.addEventListener("click", async () => {
    const user = auth.currentUser;
    if (user) {
      const profileData = {
        name: nameInput.value,
        age: ageInput.value,
        facts: factsInput.value,
        avatar: null // Assuming we'll handle avatar separately
      };

      const docRef = doc(db, "users", user.uid);
      await setDoc(docRef, profileData).then(() => {
        showNotification("Профиль сохранён!");
        profileModal.style.display = "none";
      }).catch((e) => {
        showNotification("Ошибка сохранения профиля: " + e.message, true);
      });
    }
  });

  const provider = new GoogleAuthProvider();

  // Login event
  loginBtn.addEventListener("click", () => {
    signInWithPopup(auth, provider)
      .then((result) => {
        showNotification(`Добро пожаловать, ${result.user.displayName}!`);
        loadUserMarkers(result.user.uid); // Load user markers
        profileBtn.style.display = "inline-block"; // Show profile button
      })
      .catch(e => {
        showNotification("Ошибка входа: " + e.message, true);
      });
  });

  // Logout event
  logoutBtn.addEventListener("click", () => {
    signOut(auth)
      .then(() => {
        showNotification("Вы вышли из аккаунта.");
      })
      .catch(e => {
        showNotification("Ошибка выхода: " + e.message, true);
      });
  });

  // Auth state change event
  onAuthStateChanged(auth, user => {
    if (user) {
      userInfo.textContent = `Привет, ${user.displayName}`;
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      addBtn.style.display = "flex"; // Show add button for logged in users
      profileBtn.style.display = "inline-block"; // Show profile button
      loadUserMarkers(user.uid);
    } else {
      userInfo.textContent = "Войдите, чтобы сохранять метки.";
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      addBtn.style.display = "none"; // Hide add button for logged out users
      clearMarkers();
      profileBtn.style.display = "none"; // Hide profile button
    }
  });

  // Clear markers function
  function clearMarkers() {
    markers.forEach(({marker}) => map.removeLayer(marker));
    markers = [];
  }

  // Show notifications function
  function showNotification(message, isError = false) {
    const notification = document.createElement("div");
    notification.textContent = message;
    notification.classList.add("notification");
    if (isError) {
      notification.classList.add("error");
    }
    notificationContainer.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 4000); // 4 seconds (matching animation duration)
  }

  // Load all markers when page loads
  loadAllMarkers();

  // Initially set toggle button display
  toggleControlsBtn.style.display = 'none'; // Initially hidden if controls are visible
  toggleControlsBtn.innerHTML = '<i class="fas fa-times"></i>'; // Initial icon
  setTimeout(() => {
    if (!controlsDiv.classList.contains('hidden')) {
        toggleControlsBtn.style.left = controlsDiv.offsetWidth + 30 + 'px';
    }
  }, 100); 

  // Other existing scripts...

</script>
</body>
</html>
```
