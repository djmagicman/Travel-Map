<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Тест карты и автозаполнения</title>
  <style>
    html, body, #app {
      height: 100%;
      margin: 0; padding: 0;
      font-family: Arial, sans-serif;
    }
    #app {
      display: flex;
      height: 100%;
      width: 100%;
    }
    #sidebar {
      width: 300px;
      background: #222;
      color: white;
      padding: 16px;
      box-sizing: border-box;
      position: relative;
    }
    #map {
      flex-grow: 1;
      height: 100%;
      background: #ccc;
    }
    input, button {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      margin-bottom: 10px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #city-list {
      list-style: none;
      padding: 0;
      margin: 0;
      background: white;
      color: black;
      max-height: 120px;
      overflow-y: auto;
      position: absolute;
      top: 68px; /* ниже поля ввода города */
      width: 268px;
      border: 1px solid #ccc;
      z-index: 1000;
      display: none;
    }
    #city-list li {
      padding: 5px 10px;
      cursor: pointer;
    }
    #city-list li:hover {
      background: #007bff;
      color: white;
    }
  </style>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
</head>
<body>
  <div id="app">
    <div id="sidebar">
      <h2>Добавить путешествие</h2>
      <input type="text" id="city" placeholder="Введите город" autocomplete="off" />
      <ul id="city-list"></ul>
      <input type="text" id="tripName" placeholder="Название путешествия" />
      <input type="color" id="color" value="#ff0000" />
      <button id="addBtn">Добавить метку</button>
    </div>
    <div id="map"></div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>
  <script>
    // Инициализация карты
    const map = L.map('map').setView([55.751244, 37.618423], 5);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    }).addTo(map);

    const cityInput = document.getElementById('city');
    const cityList = document.getElementById('city-list');
    const tripNameInput = document.getElementById('tripName');
    const colorInput = document.getElementById('color');
    const addBtn = document.getElementById('addBtn');

    let selectedCity = null; // сюда запишем выбранный город и координаты

    // Автозаполнение городов
    cityInput.addEventListener('input', () => {
      const val = cityInput.value.trim();
      if (val.length < 2) {
        cityList.style.display = 'none';
        cityList.innerHTML = '';
        selectedCity = null;
        return;
      }
      fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&q=${encodeURIComponent(val)}`, {
        headers: {
          'Accept-Language': 'ru',
          'Referer': location.origin
        }
      })
        .then(res => res.json())
        .then(data => {
          cityList.innerHTML = '';
          if (!data.length) {
            cityList.style.display = 'none';
            selectedCity = null;
            return;
          }
          data.forEach(place => {
            if (place.type === 'city' || place.type === 'town' || place.type === 'village') {
              const li = document.createElement('li');
              li.textContent = place.display_name;
              li.dataset.lat = place.lat;
              li.dataset.lon = place.lon;
              cityList.appendChild(li);
            }
          });
          cityList.style.display = cityList.children.length ? 'block' : 'none';
        })
        .catch(() => {
          cityList.style.display = 'none';
          selectedCity = null;
        });
    });

    // Клик по предложенному городу
    cityList.addEventListener('click', e => {
      if (e.target.tagName === 'LI') {
        cityInput.value = e.target.textContent;
        selectedCity = {
          lat: e.target.dataset.lat,
          lon: e.target.dataset.lon,
          name: e.target.textContent
        };
        cityList.style.display = 'none';
      }
    });

    // Кнопка добавить метку
    addBtn.addEventListener('click', () => {
      const tripName = tripNameInput.value.trim();
      const color = colorInput.value;

      if (!selectedCity) {
        alert('Пожалуйста, выберите город из списка');
        return;
      }
      if (!tripName) {
        alert('Пожалуйста, введите название путешествия');
        return;
      }

      const marker = L.circleMarker([selectedCity.lat, selectedCity.lon], {
        color: color,
        radius: 8,
        fillOpacity: 0.7
      }).addTo(map);

      marker.bindPopup(`<b>${tripName}</b><br>${selectedCity.name}`).openPopup();

      // Центрируем карту на метке
      map.setView([selectedCity.lat, selectedCity.lon], 10);

      // Очистка полей
      cityInput.value = '';
      tripNameInput.value = '';
      selectedCity = null;
    });

    // Закрывать список, если клик вне input или списка
    document.addEventListener('click', e => {
      if (
        e.target !== cityInput &&
        e.target.parentNode !== cityList &&
        e.target !== cityList
      ) {
        cityList.style.display = 'none';
      }
    });
  </script>
</body>
</html>
