<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Travel Map с Firebase</title>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
  html, body {
    margin: 0; 
    padding: 0; 
    height: 100%; 
    width: 100%;
    font-family: Arial, sans-serif;
  }
  #map {
    position: absolute;
    top: 0; bottom: 0; left: 0; right: 0;
    height: 100%;
    width: 100%;
    z-index: 0;
  }
  #controls {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(255 255 255 / 0.9);
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    max-width: 260px;
    z-index: 1000;
  }
  input, button {
    font-size: 1rem;
    padding: 6px;
    margin: 4px 0;
    width: 100%;
    box-sizing: border-box;
  }
  #userInfo {
    margin-bottom: 10px;
  }
  #suggestions {
    border: 1px solid #ccc;
    max-height: 120px;
    overflow-y: auto;
    background: white;
    position: absolute;
    z-index: 1001;
    width: 100%;
    left: 0;
    box-sizing: border-box;
  }
  #suggestions div {
    padding: 6px;
    cursor: pointer;
  }
  #suggestions div:hover {
    background-color: #ddd;
  }
</style>
</head>
<body>

<div id="controls">
  <div id="userInfo"></div>
  <button id="loginBtn">Войти через Google</button>
  <button id="logoutBtn" style="display:none;">Выйти</button>
  
  <label for="cityInput">Введите город:</label><br />
  <input type="text" id="cityInput" autocomplete="off" />
  <div id="suggestions"></div>

  <label for="colorInput">Цвет метки:</label><br />
  <input type="color" id="colorInput" value="#ff0000" />

  <button id="addBtn">Добавить метку</button>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase SDK (v9 Modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    query,
    where,
    getDocs
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB0c7llONI831LKFmqTIH6393ZD4ZjBOZY",
    authDomain: "travel-map-f3677.firebaseapp.com",
    projectId: "travel-map-f3677",
    storageBucket: "travel-map-f3677.firebasestorage.app",
    messagingSenderId: "692883514599",
    appId: "1:692883514599:web:0b7a71587433e67a85ae42",
    measurementId: "G-M8L8K1DL29"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const userInfo = document.getElementById("userInfo");
  const cityInput = document.getElementById("cityInput");
  const colorInput = document.getElementById("colorInput");
  const addBtn = document.getElementById("addBtn");
  const suggestionsDiv = document.getElementById("suggestions");

  const map = L.map("map").setView([55.751244, 37.618423], 5);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "© OpenStreetMap"
  }).addTo(map);

  let markers = [];
  let selectedCity = null;

  function clearMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
  }

  async function fetchCities(query) {
    if (!query) return [];
    const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&accept-language=ru&q=${encodeURIComponent(query)}`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      return data.filter(item => {
        return item.type === "city" || item.type === "town" || item.type === "village";
      });
    } catch (e) {
      return [];
    }
  }

  cityInput.addEventListener("input", async () => {
    const val = cityInput.value.trim();
    suggestionsDiv.innerHTML = "";
    selectedCity = null;
    if (val.length < 2) return;
    const cities = await fetchCities(val);
    cities.forEach(city => {
      const div = document.createElement("div");
      div.textContent = city.display_name;
      div.addEventListener("click", () => {
        cityInput.value = city.display_name;
        selectedCity = {
          name: city.display_name,
          lat: parseFloat(city.lat),
          lon: parseFloat(city.lon)
        };
        suggestionsDiv.innerHTML = "";
      });
      suggestionsDiv.appendChild(div);
    });
  });

  const provider = new GoogleAuthProvider();

  loginBtn.addEventListener("click", () => {
    signInWithPopup(auth, provider).catch(e => alert(e.message));
  });

  logoutBtn.addEventListener("click", () => {
    signOut(auth);
  });

  onAuthStateChanged(auth, user => {
    if (user) {
      userInfo.textContent = `Привет, ${user.displayName}`;
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline";
      loadUserMarkers(user.uid);
    } else {
      userInfo.textContent = "";
      loginBtn.style.display = "inline";
      logoutBtn.style.display = "none";
      clearMarkers();
    }
  });

  async function saveMarker(userId, cityName, lat, lon, color) {
    try {
      await addDoc(collection(db, "markers"), {
        userId,
        cityName,
        lat,
        lon,
        color,
        createdAt: new Date()
      });
    } catch (e) {
      alert("Ошибка при сохранении метки: " + e.message);
    }
  }

  async function loadUserMarkers(userId) {
    clearMarkers();
    const markersQuery = query(
      collection(db, "markers"),
      where("userId", "==", userId)
    );
    const querySnapshot = await getDocs(markersQuery);

    querySnapshot.forEach(doc => {
      const data = doc.data();
      const marker = L.circleMarker([data.lat, data.lon], {
        color: data.color,
        radius: 8,
        fillOpacity: 0.7
      }).addTo(map);
      marker.bindPopup(`<b>${data.cityName}</b>`);
      markers.push(marker);
    });
  }

  addBtn.addEventListener("click", async () => {
    const color = colorInput.value;

    if (!selectedCity) {
      alert("Пожалуйста, выберите город из списка");
      return;
    }

    const user = auth.currentUser;
    if (!user) {
      alert("Сначала войдите в аккаунт");
      return;
    }

    const marker = L.circleMarker([selectedCity.lat, selectedCity.lon], {
      color: color,
      radius: 8,
      fillOpacity: 0.7
    }).addTo(map);
    marker.bindPopup(`<b>${selectedCity.name}</b>`).openPopup();
    markers.push(marker);

    await saveMarker(
      user.uid,
      selectedCity.name,
      selectedCity.lat,
      selectedCity.lon,
      color
    );

    map.setView([selectedCity.lat, selectedCity.lon], 10);

    cityInput.value = "";
    selectedCity = null;
  });
</script>
</body>
</html>
