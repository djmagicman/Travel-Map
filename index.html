<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Travel Map Social —Å –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
  #authContainer, #mainContainer { max-width: 400px; margin: 30px auto; }
  #mainContainer { display: none; height: 80vh; }
  #map { height: 60vh; margin-bottom: 10px; }
  input, button, select, textarea { display: block; width: 100%; margin: 6px 0; padding: 8px; font-size: 14px; box-sizing: border-box; }
  #logoutBtn { margin-top: 10px; background: #d9534f; color: white; border: none; cursor: pointer; }
  .form-popup, .profile-popup {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: white; padding: 10px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.2);
    z-index: 10000; width: 320px; display: none;
  }
  .media-preview img, .media-preview video { max-width: 100%; margin-top: 5px; }
  .marker-toggle {
    margin: 10px 0;
  }
  .chat-box {
    background: white; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.3);
    display: flex; flex-direction: column; height: 220px;
  }
  .chat-messages {
    flex: 1; overflow-y: auto; padding: 6px; font-size: 13px; border-bottom: 1px solid #ddd;
  }
  .chat-input {
    display: flex; border-top: 1px solid #ccc;
  }
  .chat-input input { flex: 1; border: none; padding: 8px; }
  .chat-input button {
    border: none; background: #2196f3; color: white; padding: 8px 12px; cursor: pointer;
  }
</style>
</head>
<body>

<!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
<div id="authContainer">
  <h2 id="authTitle">–í—Ö–æ–¥</h2>
  <input type="tel" id="phoneInput" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" />
  <input type="password" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å" />
  <button id="authBtn">–í–æ–π—Ç–∏</button>
  <div id="authMessage" style="color:red; min-height:20px;"></div>
  <div><a href="#" id="toggleAuth">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
<div id="mainContainer">
  <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="userPhone"></span>!</h3>
  <button id="logoutBtn">–í—ã–π—Ç–∏</button>

  <div id="map"></div>

  <div class="marker-toggle">
    <label><input type="checkbox" id="toggleVisited" checked /> –ë—ã–ª</label>
    <label><input type="checkbox" id="togglePlanned" checked /> –ü–ª–∞–Ω–∏—Ä—É—é</label>
  </div>

  <button onclick="toggleProfile()">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>

  <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Å—Ç–∞ -->
  <div class="form-popup" id="form">
    <input type="text" id="placeName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞" />
    <input type="date" id="visitDate" />
    <textarea id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
    <select id="markerType">
      <option value="visited">–ë—ã–ª –∑–¥–µ—Å—å</option>
      <option value="planned">–ü–ª–∞–Ω–∏—Ä—É—é –ø–æ–µ–∑–¥–∫—É</option>
    </select>
    <input type="file" id="mediaInput" accept="image/*,video/*" multiple />
    <div class="media-preview" id="mediaPreview"></div>
    <div id="coordDisplay"></div>
    <div id="addressDisplay"></div>
    <button onclick="saveMarker()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="closeForm()">–û—Ç–º–µ–Ω–∞</button>
  </div>

  <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
  <div class="profile-popup" id="profile">
    <b>–ü—Ä–æ—Ñ–∏–ª—å</b>
    <input type="text" id="username" placeholder="–ò–º—è" />
    <input type="number" id="userage" placeholder="–í–æ–∑—Ä–∞—Å—Ç" />
    <textarea id="userdesc" placeholder="–û —Å–µ–±–µ"></textarea>
    <button onclick="saveProfile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="toggleProfile()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>

  <!-- –ß–∞—Ç -->
  <div class="chat-box">
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
      <button onclick="sendMessage()">‚û§</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
  let users = JSON.parse(localStorage.getItem('users') || '[]');
  let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');

  // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
  const authContainer = document.getElementById('authContainer');
  const mainContainer = document.getElementById('mainContainer');
  const authTitle = document.getElementById('authTitle');
  const phoneInput = document.getElementById('phoneInput');
  const passwordInput = document.getElementById('passwordInput');
  const authBtn = document.getElementById('authBtn');
  const authMessage = document.getElementById('authMessage');
  const toggleAuth = document.getElementById('toggleAuth');
  const userPhoneSpan = document.getElementById('userPhone');
  const logoutBtn = document.getElementById('logoutBtn');

  // –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ –∏ –ø—Ä–æ—Ñ–∏–ª—å
  const form = document.getElementById('form');
  const profilePopup = document.getElementById('profile');

  // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
  const placeNameInput = document.getElementById('placeName');
  const visitDateInput = document.getElementById('visitDate');
  const commentInput = document.getElementById('comment');
  const markerTypeSelect = document.getElementById('markerType');
  const mediaInput = document.getElementById('mediaInput');
  const mediaPreview = document.getElementById('mediaPreview');
  const coordDisplay = document.getElementById('coordDisplay');
  const addressDisplay = document.getElementById('addressDisplay');

  // –ú–∞—Ä–∫–µ—Ä—ã –∏ –∫–∞—Ä—Ç–∞
  let map;
  let leafletMarkers = [];
  let currentLatLng = null;

  // –ß–∞—Ç
  let chat = [];

  // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–µ–∂–¥—É –≤—Ö–æ–¥–æ–º –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π
  let isLogin = true;

  // –§—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
  function showMain() {
    authContainer.style.display = 'none';
    mainContainer.style.display = 'block';
    userPhoneSpan.textContent = currentUser.phone;
    loadUserData();
    initMap();
    renderMarkers();
    renderChat();
  }

  function showAuth() {
    authContainer.style.display = 'block';
    mainContainer.style.display = 'none';
    authMessage.textContent = '';
    phoneInput.value = '';
    passwordInput.value = '';
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
  function initMap() {
    if (map) return;
    map = L.map('map').setView([55.75, 37.62], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ - –æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    map.on('click', async function(e) {
      currentLatLng = e.latlng;
      openForm(e.latlng);
    });
  }

  // –û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
  async function openForm(latlng)
