<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Travel Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%; margin: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100%;
    }
    #controls {
      position: absolute;
      top: 10px; left: 10px;
      background: #fff;
      padding: 10px;
      z-index: 1000;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    #suggestions {
      border: 1px solid #ccc;
      max-height: 120px;
      overflow-y: auto;
      background: white;
      position: absolute;
      z-index: 1000;
      width: 220px;
    }
    #suggestions div {
      padding: 6px;
      cursor: pointer;
    }
    #suggestions div:hover {
      background-color: #eee;
    }
    input, button, textarea {
      font-size: 1rem;
      margin-bottom: 6px;
      width: 100%;
      box-sizing: border-box;
    }
    .thumb {
      width: 60px;
      height: auto;
      margin: 2px;
    }
  </style>
</head>
<body>
<div id="controls">
  <div id="userInfo"></div>
  <button id="loginBtn">Войти через Google</button>
  <button id="logoutBtn" style="display:none;">Выйти</button>
  <br />
  <input type="text" id="cityInput" placeholder="Введите город" autocomplete="off" />
  <div id="suggestions"></div>
  <input type="color" id="colorInput" value="#ff0000" />
  <textarea id="commentInput" placeholder="Комментарий"></textarea>
  <input type="file" id="photoInput" accept="image/*" multiple />
  <button id="addBtn">Добавить метку</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, getDocs, query, where, doc, deleteDoc, updateDoc
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  import {
    getStorage, ref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB0c7llONI831LKFmqTIH6393ZD4ZjBOZY",
    authDomain: "travel-map-f3677.firebaseapp.com",
    projectId: "travel-map-f3677",
    storageBucket: "travel-map-f3677.appspot.com",
    messagingSenderId: "692883514599",
    appId: "1:692883514599:web:0b7a71587433e67a85ae42",
    measurementId: "G-M8L8K1DL29"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const userInfo = document.getElementById("userInfo");
  const cityInput = document.getElementById("cityInput");
  const colorInput = document.getElementById("colorInput");
  const commentInput = document.getElementById("commentInput");
  const photoInput = document.getElementById("photoInput");
  const addBtn = document.getElementById("addBtn");
  const suggestionsDiv = document.getElementById("suggestions");

  const map = L.map("map").setView([55.75, 37.61], 5);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  let selectedCity = null;
  let markers = [];

  // Suggestions
  cityInput.addEventListener("input", async () => {
    const val = cityInput.value.trim();
    suggestionsDiv.innerHTML = "";
    selectedCity = null;
    if (val.length < 2) return;
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&limit=5&accept-language=ru`;
    const res = await fetch(url);
    const data = await res.json();
    data.forEach(city => {
      const div = document.createElement("div");
      div.textContent = city.display_name;
      div.addEventListener("click", () => {
        cityInput.value = city.display_name;
        selectedCity = {
          name: city.display_name,
          lat: parseFloat(city.lat),
          lon: parseFloat(city.lon)
        };
        suggestionsDiv.innerHTML = "";
      });
      suggestionsDiv.appendChild(div);
    });
  });

  const provider = new GoogleAuthProvider();
  loginBtn.addEventListener("click", () => signInWithPopup(auth, provider));
  logoutBtn.addEventListener("click", () => signOut(auth));

  onAuthStateChanged(auth, user => {
    if (user) {
      userInfo.textContent = `Привет, ${user.displayName}`;
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline";
      loadMarkers(user.uid);
    } else {
      userInfo.textContent = "";
      loginBtn.style.display = "inline";
      logoutBtn.style.display = "none";
      clearMarkers();
    }
  });

  async function uploadPhotos(userId, files) {
    const urls = [];
    for (const file of files) {
      const photoRef = ref(storage, `photos/${userId}/${Date.now()}_${file.name}`);
      await uploadBytes(photoRef, file);
      const url = await getDownloadURL(photoRef);
      urls.push(url);
    }
    return urls;
  }

  async function loadMarkers(userId) {
    clearMarkers();
    const q = query(collection(db, "markers"), where("userId", "==", userId));
    const snap = await getDocs(q);
    snap.forEach(docSnap => {
      const data = docSnap.data();
      const marker = L.circleMarker([data.lat, data.lon], {
        color: data.color || "#000", radius: 8, fillOpacity: 0.7
      }).addTo(map);
      marker.bindPopup(createPopupHTML(data, docSnap.id));
      marker.on("click", () => marker.openPopup());
      markers.push(marker);
    });
  }

  function createPopupHTML(data, id) {
    let photosHTML = "";
    if (data.photos && data.photos.length) {
      photosHTML = data.photos.map(url => `<img src="${url}" class="thumb" />`).join("");
    }
    return `
      <b>${data.cityName}</b><br/>
      ${data.comment ? `<i>${data.comment}</i><br/>` : ""}
      ${photosHTML}<br/>
      <button onclick="window.editMarker('${id}')">Редактировать</button>
      <button onclick="window.deleteMarker('${id}')">Удалить</button>
    `;
  }

  window.editMarker = async (id) => {
    const markerRef = doc(db, "markers", id);
    const snap = await getDocs(query(collection(db, "markers"), where("__name__", "==", id)));
    if (snap.empty) return alert("Метка не найдена");
    const data = snap.docs[0].data();
    cityInput.value = data.cityName;
    colorInput.value = data.color;
    commentInput.value = data.comment || "";
    selectedCity = { name: data.cityName, lat: data.lat, lon: data.lon };
    await deleteDoc(markerRef);
    loadMarkers(auth.currentUser.uid);
  };

  window.deleteMarker = async (id) => {
    await deleteDoc(doc(db, "markers", id));
    loadMarkers(auth.currentUser.uid);
  };

  function clearMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
  }

  addBtn.addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) return alert("Сначала войдите в аккаунт");
    if (!selectedCity) return alert("Выберите город из списка");

    const color = colorInput.value;
    const comment = commentInput.value;
    const files = photoInput.files;
    let photoURLs = [];

    if (files.length > 0) {
      photoURLs = await uploadPhotos(user.uid, files);
    }

    await addDoc(collection(db, "markers"), {
      userId: user.uid,
      cityName: selectedCity.name,
      lat: selectedCity.lat,
      lon: selectedCity.lon,
      color,
      comment,
      photos: photoURLs,
      createdAt: new Date()
    });

    cityInput.value = "";
    commentInput.value = "";
    photoInput.value = "";
    selectedCity = null;

    loadMarkers(user.uid);
  });
</script>
</body>
</html>
