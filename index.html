<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Travel Map Social</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-sA+ePHLZo2jrgdZ0Q9HmvBbd8lw6IbdZ0osAJs6l0lg="
  crossorigin=""
/>
<style>
  /* Сброс и базовые стили */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin:0; padding:0; height:100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden;
  }
  #app {
    display: flex;
    height: 100vh;
    width: 100vw;
  }
  /* Боковое меню */
  #sidebar {
    width: 320px;
    background: #222;
    color: #eee;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    user-select: none;
  }
  #sidebar header {
    padding: 20px;
    border-bottom: 1px solid #444;
  }
  #avatar-container {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  #avatar-container img {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #4caf50;
    background: #444;
  }
  #user-info {
    flex-grow: 1;
  }
  #user-info h2 {
    margin: 0 0 6px 0;
    font-size: 1.25em;
  }
  #user-info small {
    display: block;
    color: #aaa;
    font-size: 0.9em;
    margin-bottom: 4px;
  }
  #user-comment {
    font-style: italic;
    font-size: 0.9em;
    color: #bbb;
  }
  /* Главное меню кнопок снизу */
  #sidebar footer {
    border-top: 1px solid #444;
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
  }
  #sidebar footer button {
    background: #444;
    border: none;
    color: #eee;
    padding: 10px 14px;
    border-radius: 4px;
    cursor: pointer;
    flex: 1;
    margin: 0 5px;
    font-weight: 600;
    transition: background 0.3s ease;
  }
  #sidebar footer button:hover,
  #sidebar footer button.active {
    background: #4caf50;
    color: white;
  }
  /* Вкладки контента */
  #content {
    flex-grow: 1;
    background: #fafafa;
    overflow-y: auto;
    padding: 20px;
  }
  .tab {
    display: none;
  }
  .tab.active {
    display: block;
  }
  /* Профиль */
  #profile form {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-width: 300px;
  }
  #profile label {
    font-weight: 600;
    margin-bottom: 4px;
  }
  #profile input[type=text],
  #profile input[type=number],
  #profile textarea {
    padding: 8px;
    font-size: 1em;
    border: 1px solid #ccc;
    border-radius: 4px;
    width: 100%;
  }
  #profile textarea {
    resize: vertical;
  }
  #profile input[type=file] {
    border: none;
    padding: 0;
  }
  #profile button {
    padding: 10px;
    background: #4caf50;
    border: none;
    color: white;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
  }
  #profile button:hover {
    background: #388e3c;
  }
  /* Друзья */
  #friends {
    max-width: 500px;
  }
  #friends .search {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  #friends input[type=text] {
    flex-grow: 1;
    padding: 8px;
    font-size: 1em;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  #friends button {
    padding: 8px 14px;
    border: none;
    background: #4caf50;
    color: white;
    border-radius: 4px;
    cursor: pointer;
  }
  #friends ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  #friends li {
    padding: 8px 12px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #friends li:last-child {
    border-bottom: none;
  }
  #friends li button {
    background: #2196f3;
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
  }
  /* Путешествия */
  #trips {
    max-width: 600px;
  }
  #trips form {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 20px;
  }
  #trips label {
    font-weight: 600;
  }
  #trips input[type=text], #trips input[type=color] {
    padding: 8px;
    font-size: 1em;
    border-radius: 4px;
    border: 1px solid #ccc;
    width: 100%;
  }
  #trips button {
    padding: 10px;
    background: #4caf50;
    border: none;
    color: white;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
  }
  #trips button:hover {
    background: #388e3c;
  }
  #trip-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  #trip-list li {
    padding: 8px 12px;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #trip-list li:last-child {
    border-bottom: none;
  }
  #trip-list li:hover {
    background: #eee;
  }
  #trip-list li button {
    background: #f44336;
    border: none;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
  }
  /* Карта */
  #map {
    flex-grow: 1;
  }
  /* Подсказка маркера (popup) */
  .leaflet-popup-content-wrapper {
    max-width: 280px;
  }
  .marker-photo {
    max-width: 100%;
    max-height: 150px;
    display: block;
    margin-top: 8px;
    border-radius: 6px;
  }
  /* Форма добавления/редактирования метки */
  .marker-form label {
    display: block;
    margin: 8px 0 4px;
  }
  .marker-form input[type=text],
  .marker-form textarea,
  .marker-form select,
  .marker-form input[type=color],
  .marker-form input[type=file] {
    width: 100%;
    padding: 6px;
    box-sizing: border-box;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  .marker-form textarea {
    resize: vertical;
  }
  .marker-form button {
    margin-top: 10px;
    padding: 8px 12px;
    background: #4caf50;
    border: none;
    color: white;
    border-radius: 4px;
    cursor: pointer;
  }
  .marker-form button:hover {
    background: #388e3c;
  }
  /* Адаптив */
  @media (max-width: 800px) {
    #sidebar {
      width: 100vw;
      height: 320px;
      flex-shrink: 0;
      order: 2;
      overflow-y: auto;
    }
    #content {
      height: calc(100vh - 320px);
      overflow-y: auto;
    }
    #app {
      flex-direction: column;
    }
    #map {
      height: 100vh;
      order: 1;
    }
  }
</style>
</head>
<body>
<div id="app">
  <nav id="sidebar" aria-label="Сайдбар меню">
    <header>
      <div id="avatar-container" tabindex="0" aria-label="Профиль пользователя">
        <img id="avatar-img" src="" alt="Аватар пользователя" />
        <div id="user-info">
          <h2 id="user-name">Гость</h2>
          <small id="user-age"></small>
          <p id="user-comment"></p>
        </div>
      </div>
    </header>

    <section id="content">
      <!-- Вкладка Профиль -->
      <div id="profile" class="tab active" role="tabpanel" aria-labelledby="btn-profile">
        <h3>Профиль</h3>
        <form id="profile-form" novalidate>
          <label for="profile-name">Имя:</label>
          <input type="text" id="profile-name" name="name" placeholder="Ваше имя" required />

          <label for="profile-age">Возраст:</label>
          <input type="number" id="profile-age" name="age" min="1" max="120" placeholder="Возраст" required />

          <label for="profile-comment">Комментарий:</label>
          <textarea id="profile-comment-input" name="comment" rows="3" placeholder="Расскажите о себе"></textarea>

          <label for="profile-avatar">Аватар:</label>
          <input type="file" id="profile-avatar" name="avatar" accept="image/*" />

          <button type="submit">Сохранить профиль</button>
        </form>
      </div>

      <!-- Вкладка Друзья -->
      <div id="friends" class="tab" role="tabpanel" aria-labelledby="btn-friends">
        <h3>Друзья</h3>
        <div class="search">
          <input type="text" id="friend-search-input" placeholder="Поиск друзей по имени или email" aria-label="Поиск друзей" />
          <button id="friend-search-btn" aria-label="Поиск друзей">Найти</button>
        </div>
        <ul id="friend-list" aria-live="polite" aria-relevant="additions"></ul>
      </div>

      <!-- Вкладка Путешествия -->
      <div id="trips" class="tab" role="tabpanel" aria-labelledby="btn-trips">
        <h3>Путешествия</h3>
        <form id="trip-form" novalidate>
          <label for="trip-start">Начальная точка (город):</label>
          <input type="text" id="trip-start" placeholder="Город начала" required />

          <label for="trip-end">Конечная точка (город):</label>
          <input type="text" id="trip-end" placeholder="Город конца" required />

          <label for="trip-stops">Промежуточные города (через запятую):</label>
          <input type="text" id="trip-stops" placeholder="Город1, Город2, ..." />

          <label for="trip-color">Цвет маршрута:</label>
          <input type="color" id="trip-color" value="#4caf50" />

          <button type="submit">Создать путешествие</button>
        </form>

        <ul id="trip-list" aria-live="polite" aria-relevant="additions"></ul>
      </div>
    </section>

    <footer>
      <button id="btn-profile" class="active" aria-controls="profile" aria-selected="true" role="tab">Профиль</button>
      <button id="btn-friends" aria-controls="friends" aria-selected="false" role="tab">Друзья</button>
      <button id="btn-trips" aria-controls="trips" aria-selected="false" role="tab">Путешествия</button>
    </footer>
  </nav>

  <div id="map" aria-label="Карта путешествий"></div>
</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-oPke0b2mDhmlyOyP0klybspjC+8rsOaH7ZNPtkEpr6w="
  crossorigin=""
></script>
<script>
(() => {
  'use strict';

  // --- Переменные хранения ---
  let user = {
    name: 'Гость',
    age: '',
    comment: '',
    avatar: ''
  };

  // Друзья: {id, name, email, inviteLink, accepted}
  let friends = [];

  // Метки на карте
  // Каждый маркер: id, lat, lng, title, description, photo(base64), color, travelType ('been'|'planned')
  let markersData = [];

  // Путешествия: id, start, end, stops[], color, route (array of latlng)
  let trips = [];

  // Leaflet объекты
  let map, leafletMarkers = new Map(); // id -> marker
  let leafletRoutes = new Map(); // tripId -> polyline

  // Текущая вкладка
  let currentTab = 'profile';

  // --- Инициализация карты ---
  function initMap() {
    map = L.map('map').setView([55.7558, 37.6173], 4); // Москва по умолчанию
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Клик по карте - добавить маркер
    map.on('click', onMapClick);
  }

  // --- Загрузка данных из localStorage ---
  function loadFromStorage() {
    const userRaw = localStorage.getItem('tms_user');
    if (userRaw) {
      try {
        user = JSON.parse(userRaw);
      } catch {}
    }
    const friendsRaw = localStorage.getItem('tms_friends');
    if (friendsRaw) {
      try {
        friends = JSON.parse(friendsRaw);
      } catch {}
    }
    const markersRaw = localStorage.getItem('tms_markers');
    if (markersRaw) {
      try {
        markersData = JSON.parse(markersRaw);
      } catch {}
    }
    const tripsRaw = localStorage.getItem('tms_trips');
    if (tripsRaw) {
      try {
        trips = JSON.parse(tripsRaw);
      } catch {}
    }
  }

  // --- Сохранение в localStorage ---
  function saveToStorage() {
    localStorage.setItem('tms_user', JSON.stringify(user));
    localStorage.setItem('tms_friends', JSON.stringify(friends));
    localStorage.setItem('tms_markers', JSON.stringify(markersData));
    localStorage.setItem('tms_trips', JSON.stringify(trips));
  }

  // --- Отобразить профиль в меню ---
  function renderProfileMenu() {
    document.getElementById('avatar-img').src = user.avatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
    document.getElementById('user-name').textContent = user.name || 'Гость';
    document.getElementById('user-age').textContent = user.age ? `Возраст: ${user.age}` : '';
    document.getElementById('user-comment').textContent = user.comment || '';
  }

  // --- Заполнить форму профиля ---
  function fillProfileForm() {
    document.getElementById('profile-name').value = user.name || '';
    document.getElementById('profile-age').value = user.age || '';
    document.getElementById('profile-comment-input').value = user.comment || '';
  }

  // --- Инициализация профиля ---
  function initProfile() {
    fillProfileForm();
    renderProfileMenu();

    const form = document.getElementById('profile-form');
    form.addEventListener('submit', e => {
      e.preventDefault();
      const name = form['name'].value.trim();
      const age = form['age'].value.trim();
      const comment = form['comment'].value.trim();

      if (!name) {
        alert('Введите имя');
        return;
      }
      if (!age || isNaN(age) || age < 1 || age > 120) {
        alert('Введите корректный возраст');
        return;
      }
      user.name = name;
      user.age = age;
      user.comment = comment;
      saveToStorage();
      renderProfileMenu();
      alert('Профиль сохранён');
    });

    // Загрузка аватара
    const avatarInput = document.getElementById('profile-avatar');
    avatarInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) {
        alert('Выберите изображение');
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        user.avatar = reader.result;
        saveToStorage();
        renderProfileMenu();
        avatarInput.value = '';
      };
      reader.readAsDataURL(file);
    });
  }

  // --- Создание маркера Leaflet по данным ---
  function createLeafletMarker(data) {
    // Используем цвет и travelType для иконки
    const icon = L.divIcon({
      className: '',
      html: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="48" viewBox="0 0 32 48" fill="none">
        <path fill="${data.color}" stroke="#222" stroke-width="2" d="M16 0C7 0 0 10 0 18c0 14 16 30 16 30s16-16 16-30c0-8-7-18-16-18z"/>
        <circle cx="16" cy="18" r="6" fill="${data.travelType === 'been' ? '#000' : '#fff'}" stroke="#222" stroke-width="2"/>
      </svg>`,
      iconSize: [32, 48],
      iconAnchor: [16, 48],
      popupAnchor: [0, -48],
      className: ''
    });

    const marker = L.marker([data.lat, data.lng], { icon, draggable: true, autoPan: true });

    // Содержание popup
    const popupContent = document.createElement('div');
    popupContent.style.minWidth = '250px';

    function buildPopupContent(editMode = false) {
      popupContent.innerHTML = '';

      if (!editMode) {
        const titleEl = document.createElement('h4');
        titleEl.textContent = data.title;
        popupContent.appendChild(titleEl);

        const descEl = document.createElement('p');
        descEl.textContent = data.description;
        popupContent.appendChild(descEl);

        if (data.photo) {
          const img = document.createElement('img');
          img.src = data.photo;
          img.alt = `Фото: ${data.title}`;
          img.className = 'marker-photo';
          popupContent.appendChild(img);
        }

        const coordsEl = document.createElement('small');
        coordsEl.textContent = `Координаты: ${data.lat.toFixed(5)}, ${data.lng.toFixed(5)}`;
        popupContent.appendChild(coordsEl);

        const travelTypeEl = document.createElement('p');
        travelTypeEl.textContent = data.travelType === 'been' ? 'Был там' : 'Планирую';
        travelTypeEl.style.fontWeight = 'bold';
        popupContent.appendChild(travelTypeEl);

        const editBtn = document.createElement('button');
        editBtn.textContent = 'Редактировать';
        editBtn.style.marginTop = '8px';
        editBtn.style.padding = '6px 10px';
        editBtn.style.cursor = 'pointer';
        editBtn.style.backgroundColor = '#4caf50';
        editBtn.style.color = '#fff';
        editBtn.style.border = 'none';
        editBtn.style.borderRadius = '4px';

        editBtn.onclick = () => {
          buildPopupContent(true);
          marker.openPopup();
        };

        popupContent.appendChild(editBtn);
      } else {
        // Форма редактирования
        const form = document.createElement('form');
        form.className = 'marker-form';

        form.innerHTML = `
          <label for="marker-title">Название:</label>
          <input type="text" id="marker-title" name="title" required value="${data.title}" />
          <label for="marker-description">Описание:</label>
          <textarea id="marker-description" name="description" rows="3">${data.description}</textarea>
          <label for="marker-photo">Фото:</label>
          <input type="file" id="marker-photo" name="photo" accept="image/*" />
          ${data.photo ? `<img src="${data.photo}" alt="Фото" class="marker-photo" style="margin-top:4px; max-height: 100px;"/>` : ''}
          <label for="marker-color">Цвет флажка:</label>
          <input type="color" id="marker-color" name="color" value="${data.color}" />
          <label for="marker-travelType">Тип путешествия:</label>
          <select id="marker-travelType" name="travelType">
            <option value="been" ${data.travelType === 'been' ? 'selected' : ''}>Был там</option>
            <option value="planned" ${data.travelType === 'planned' ? 'selected' : ''}>Планирую</option>
          </select>
          <button type="submit">Сохранить</button>
        `;

        // Загрузка фото при выборе
        const photoInput = form.querySelector('#marker-photo');
        photoInput.addEventListener('change', e => {
          const file = e.target.files[0];
          if (!file) return;
          if (!file.type.startsWith('image/')) {
            alert('Выберите изображение');
            return;
          }
          const reader = new FileReader();
          reader.onload = () => {
            data.photo = reader.result;
            saveMarkerData();
            buildPopupContent(true);
            marker.openPopup();
          };
          reader.readAsDataURL(file);
        });

        form.addEventListener('submit', e => {
          e.preventDefault();
          const f = e.target;
          const newTitle = f.title.value.trim();
          if (!newTitle) {
            alert('Введите название');
            return;
          }
          data.title = newTitle;
          data.description = f.description.value.trim();
          data.color = f.color.value;
          data.travelType = f.travelType.value;
          saveMarkerData();
          updateMarkerIcon(marker, data);
          buildPopupContent(false);
          marker.openPopup();
        });

        popupContent.appendChild(form);
      }
    }

    buildPopupContent(false);

    marker.bindPopup(popupContent);

    // Обновлять координаты в data при перетаскивании
    marker.on('dragend', () => {
      const pos = marker.getLatLng();
      data.lat = pos.lat;
      data.lng = pos.lng;
      saveMarkerData();
    });

    return marker;
  }

  // --- Обновить иконку маркера при изменении цвета и типа ---
  function updateMarkerIcon(marker, data) {
    const icon = L.divIcon({
      className: '',
      html: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="48" viewBox="0 0 32 48" fill="none">
        <path fill="${data.color}" stroke="#222" stroke-width="2" d="M16 0C7 0 0 10 0 18c0 14 16 30 16 30s16-16 16-30c0-8-7-18-16-18z"/>
        <circle cx="16" cy="18" r="6" fill="${data.travelType === 'been' ? '#000' : '#fff'}" stroke="#222" stroke-width="2"/>
      </svg>`,
      iconSize: [32, 48],
      iconAnchor: [16, 48],
      popupAnchor: [0, -48],
      className: ''
    });
    marker.setIcon(icon);
  }

  // --- Сохранить маркеры ---
  function saveMarkerData() {
    localStorage.setItem('tms_markers', JSON.stringify(markersData));
  }

  // --- Отобразить маркеры на карте ---
  function renderMarkers() {
    // Сначала очистить все Leaflet маркеры
    leafletMarkers.forEach(m => map.removeLayer(m));
    leafletMarkers.clear();

    markersData.forEach(data => {
      const marker = createLeafletMarker(data);
      marker.addTo(map);
      leafletMarkers.set(data.id, marker);
    });
  }

  // --- Обработчик клика по карте для добавления маркера ---
  function onMapClick(e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    // Создать пустой объект метки с дефолтными значениями
    const newMarker = {
      id: 'm' + Date.now(),
      lat, lng,
      title: 'Новое место',
      description: '',
      photo: '',
      color: '#4caf50',
      travelType: 'planned'
    };

    markersData.push(newMarker);
    saveMarkerData();
    renderMarkers();

    // Открыть popup с формой редактирования у нового маркера
    const marker = leafletMarkers.get(newMarker.id);
    marker.openPopup();
  }

  // --- Вкладка Друзья ---
  function initFriends() {
    const input = document.getElementById('friend-search-input');
    const btn = document.getElementById('friend-search-btn');
    const list = document.getElementById('friend-list');

    function renderFriends(filter = '') {
      const filtered = friends.filter(f => {
        const term = filter.toLowerCase();
        return f.name.toLowerCase().includes(term) || (f.email && f.email.toLowerCase().includes(term));
      });
      list.innerHTML = '';
      if (filtered.length === 0) {
        list.innerHTML = '<li>Друзья не найдены</li>';
        return;
      }
      filtered.forEach(f => {
        const li = document.createElement('li');
        li.textContent = f.name + (f.email ? ` (${f.email})` : '');
        // Кнопка приглашения
        const btnInvite = document.createElement('button');
        btnInvite.textContent = 'Пригласить';
        btnInvite.onclick = () => {
          alert(`Скопируйте ссылку для приглашения:\n\n${f.inviteLink || 'https://travel-map-social.example.com/profile/' + f.id}`);
        };
        li.appendChild(btnInvite);
        list.appendChild(li);
      });
    }

    btn.addEventListener('click', () => {
      const val = input.value.trim();
      if (!val) {
        alert('Введите имя или email для поиска');
        return;
      }
      renderFriends(val);
    });

    // При загрузке показать всех
    renderFriends();
  }

  // --- Вкладка Путешествия ---
  function initTrips() {
    const form = document.getElementById('trip-form');
    const tripList = document.getElementById('trip-list');

    function renderTrips() {
      tripList.innerHTML = '';
      if (trips.length === 0) {
        tripList.innerHTML = '<li>Путешествия отсутствуют</li>';
        return;
      }
      trips.forEach(t => {
        const li = document.createElement('li');
        li.textContent = `${t.start} → ${t.stops.length ? t.stops.join(' → ') + ' → ' : ''}${t.end}`;
        li.style.color = t.color;
        // Кнопка удалить
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Удалить';
        delBtn.onclick = (e) => {
          e.stopPropagation();
          if (!confirm('Удалить это путешествие?')) return;
          removeTrip(t.id);
        };
        li.appendChild(delBtn);

        li.onclick = () => {
          showTripOnMap(t);
        };
        tripList.appendChild(li);
      });
    }

    function removeTrip(id) {
      trips = trips.filter(t => t.id !== id);
      saveTrips();
      renderTrips();
      removeRouteFromMap(id);
    }

    function saveTrips() {
      localStorage.setItem('tms_trips', JSON.stringify(trips));
    }

    // Функция показать маршрут на карте зелёной линией
    function showTripOnMap(trip) {
      removeAllRoutes();

      // Геокодируем города (простейшим способом - через Nominatim API)
      // Чтобы не блокировать UI, сделаем цепочку запросов async/await

      async function geocode(city) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`;
        try {
          const resp = await fetch(url, { headers: {'Accept-Language': 'ru'} });
          const data = await resp.json();
          if (data && data.length > 0) {
            return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
          }
          return null;
        } catch {
          return null;
        }
      }

      (async () => {
        const points = [];
        let failCount = 0;
        const cities = [trip.start, ...trip.stops, trip.end];
        for (const city of cities) {
          const pos = await geocode(city);
          if (pos) points.push(pos);
          else {
            alert(`Не удалось найти координаты города: ${city}`);
            failCount++;
          }
        }
        if (points.length < 2) {
          alert('Недостаточно координат для построения маршрута');
          return;
        }
        // Добавить маршрут на карту
        const polyline = L.polyline(points, {color: trip.color || '#4caf50', weight: 5}).addTo(map);
        leafletRoutes.set(trip.id, polyline);
        map.fitBounds(polyline.getBounds());
      })();
    }

    function removeRouteFromMap(id) {
      const line = leafletRoutes.get(id);
      if (line) {
        map.removeLayer(line);
        leafletRoutes.delete(id);
      }
    }

    function removeAllRoutes() {
      leafletRoutes.forEach(line => {
        map.removeLayer(line);
      });
      leafletRoutes.clear();
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      const start = form['trip-start'].value.trim();
      const end = form['trip-end'].value.trim();
      const stopsRaw = form['trip-stops'].value.trim();
      const color = form['trip-color'].value;

      if (!start || !end) {
        alert('Введите начальную и конечную точки');
        return;
      }

      const stops = stopsRaw ? stopsRaw.split(',').map(s => s.trim()).filter(Boolean) : [];

      const newTrip = {
        id: 't' + Date.now(),
        start, end, stops, color,
      };

      trips.push(newTrip);
      saveTrips();
      renderTrips();

      // Показать маршрут сразу
      showTripOnMap(newTrip);

      form.reset();
      form['trip-color'].value = '#4caf50';
    });

    renderTrips();
  }

  // --- Навигация вкладок ---
  function initTabs() {
    const buttons = document.querySelectorAll('#sidebar footer button');
    const tabs = document.querySelectorAll('#content .tab');

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        if (btn.id === `btn-${currentTab}`) return;

        // Активный btn
        buttons.forEach(b => {
          b.classList.remove('active');
          b.setAttribute('aria-selected', 'false');
        });
        btn.classList.add('active');
        btn.setAttribute('aria-selected', 'true');

        // Показать вкладку
        tabs.forEach(t => t.classList.remove('active'));
        const tabId = btn.id.replace('btn-', '');
        const tab = document.getElementById(tabId);
        if (tab) tab.classList.add('active');

        currentTab = tabId;
      });
    });
  }

  // --- Инициализация всего ---
  function init() {
    loadFromStorage();
    initMap();
    initProfile();
    initFriends();
    initTrips();
    initTabs();
    renderProfileMenu();
    renderMarkers();
  }

  window.addEventListener('load', init);
})();
</script>
</body>
</html>
