<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Travel Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
  html, body, #map {
    height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif;
  }
  #map { position: relative; }
  .form-popup, .info-popup {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    z-index: 10000;
    width: 340px;
    max-height: 80vh;
    overflow-y: auto;
    display: none;
  }
  .form-popup input[type="text"],
  .form-popup input[type="date"],
  .form-popup textarea,
  .form-popup select {
    width: 100%;
    margin-top: 8px;
    padding: 6px;
    box-sizing: border-box;
    font-size: 14px;
  }
  .form-popup label {
    font-weight: bold;
    margin-top: 10px;
    display: block;
  }
  .form-popup button {
    margin-top: 12px;
    padding: 8px;
    width: 100%;
    cursor: pointer;
    font-weight: bold;
    background-color: #2E8B57;
    color: white;
    border: none;
    border-radius: 5px;
  }
  .form-popup button.delete-btn {
    background-color: #c0392b;
    margin-top: 6px;
  }
  .form-popup button.cancel-btn {
    background: #aaa;
    margin-top: 6px;
  }
  .info-popup button.close-btn {
    background: #aaa;
    border: none;
    padding: 6px 10px;
    cursor: pointer;
    border-radius: 5px;
    float: right;
    font-weight: bold;
  }
  .info-popup h2 {
    margin: 0 0 10px 0;
  }
  .info-popup .media img, 
  .info-popup .media video, 
  .info-popup .media iframe {
    max-width: 100%;
    margin-top: 10px;
    border-radius: 6px;
    display: block;
  }
  .signature {
    position: fixed;
    bottom: 10px;
    left: 10px;
    font-size: 13px;
    color: rgba(0,0,0,0.5);
    font-style: italic;
    user-select: none;
    z-index: 9999;
  }
  .hint {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(255,255,255,0.85);
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 9999;
    user-select: none;
  }
  .media-url-group {
    display: flex;
    margin-top: 6px;
  }
  .media-url-group input {
    flex-grow: 1;
  }
  .media-url-group button {
    margin-left: 6px;
    padding: 5px 10px;
    background: #c0392b;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .media-url-item {
    position: relative;
    margin-top: 5px;
  }
  .media-url-item button {
    position: absolute;
    right: 0;
    top: 0;
    padding: 0 6px;
    background: #c0392b;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
  }
</style>
</head>
<body>

<div id="map"></div>

<div class="hint">üñ±Ô∏è –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ ‚Äî –¥–æ–±–∞–≤–∏—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—á–∫—É</div>

<!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div class="form-popup" id="markerForm" tabindex="0">
  <label for="placeName">–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ *</label>
  <input type="text" id="placeName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ú–æ—Å–∫–≤–∞" required />

  <label for="visitDate">–î–∞—Ç–∞ –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è</label>
  <input type="date" id="visitDate" />

  <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
  <textarea id="comment" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –æ—á–µ–Ω—å –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å!"></textarea>

  <label for="markerType">–¢–∏–ø –æ—Ç–º–µ—Ç–∫–∏</label>
  <select id="markerType">
    <option value="visited">–ë—ã–ª –∑–¥–µ—Å—å</option>
    <option value="planned">–ü–ª–∞–Ω–∏—Ä—É—é –ø–æ–µ—Ö–∞—Ç—å</option>
  </select>

  <label>–§–æ—Ç–æ/–í–∏–¥–µ–æ (—Å—Å—ã–ª–∫–∏)</label>
  <div id="mediaContainer"></div>
  <div class="media-url-group">
    <input type="text" id="mediaUrlInput" placeholder="URL —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ" />
    <button id="addMediaBtn" title="–î–æ–±–∞–≤–∏—Ç—å –º–µ–¥–∏–∞">‚ûï</button>
  </div>

  <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button id="deleteBtn" class="delete-btn" style="display:none;">–£–¥–∞–ª–∏—Ç—å</button>
  <button id="cancelBtn" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
</div>

<!-- –û–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
<div class="info-popup" id="infoPopup" tabindex="0">
  <button class="close-btn" id="closeInfoBtn">√ó</button>
  <h2 id="infoName"></h2>
  <div><b>–î–∞—Ç–∞ –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è:</b> <span id="infoDate"></span></div>
  <div><b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</b> <p id="infoComment"></p></div>
  <div><b>–¢–∏–ø –æ—Ç–º–µ—Ç–∫–∏:</b> <span id="infoType"></span></div>
  <div class="media" id="infoMedia"></div>
  <button id="editFromInfoBtn" style="margin-top:10px; background:#2E8B57; color:#fff; border:none; border-radius:5px; padding: 8px; cursor:pointer;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
</div>

<div class="signature">–°–¥–µ–ª–∞–Ω–æ —Å –¥—É—à–æ–π –ú–∏—à–∫–æ–π ‚ù§Ô∏è</div>

<script>
  const map = L.map('map').setView([55.75, 37.62], 4);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let markers = JSON.parse(localStorage.getItem('markers')) || [];
  let leafletMarkers = [];
  let editingIndex = null;
  let currentLatLngForNew = null;

  const colors = { visited: 'green', planned: 'blue' };

  function createIcon(color) {
    return L.divIcon({
      className: 'custom-marker',
      html: `<div style="
        width: 18px; height: 18px;
        background: ${color};
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 5px rgba(0,0,0,0.3);
      "></div>`,
      iconSize: [18, 18],
      iconAnchor: [9, 9]
    });
  }

  function createMarker(data, index) {
    const icon = createIcon(colors[data.type] || 'gray');
    const marker = L.marker([data.lat, data.lng], { icon, draggable: true }).addTo(map);

    marker.on('dragend', e => {
      const pos = e.target.getLatLng();
      markers[index].lat = pos.lat;
      markers[index].lng = pos.lng;
      saveMarkers();
    });

    marker.on('click', () => {
      if (data.type === 'visited') {
        openInfo(index);
      } else {
        openForm(index);
      }
    });

    return marker;
  }

  function renderMarkers() {
    leafletMarkers.forEach(m => map.removeLayer(m));
    leafletMarkers = markers.map((m, i) => createMarker(m, i));
  }

  function saveMarkers() {
    localStorage.setItem('markers', JSON.stringify(markers));
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ - —ç—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ YouTube
  function isYouTubeUrl(url) {
    return /youtube\.com\/watch|youtu\.be\//.test(url);
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ - —ç—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ Vimeo
  function isVimeoUrl(url) {
    return /vimeo\.com\//.test(url);
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è iframe –¥–ª—è –≤–∏–¥–µ–æ
  function generateVideoEmbed(url) {
    if (isYouTubeUrl(url)) {
      let videoId = null;
      const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([A-Za-z0-9_-]+)/);
      if (ytMatch) videoId = ytMatch[1];
      if (videoId) return `<iframe width="100%" height="200" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
    }
    if (isVimeoUrl(url)) {
      const vmMatch = url.match(/vimeo\.com\/(\d+)/);
      if (vmMatch) {
        return `<iframe width="100%" height="200" src="https://player.vimeo.com/video/${vmMatch[1]}" frameborder="0" allowfullscreen></iframe>`;
      }
    }
    return '';
  }

  // –†–µ–Ω–¥–µ—Ä –º–µ–¥–∏–∞ –≤ –æ–∫–Ω–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
  function renderMediaView(mediaUrls) {
    const container = document.getElementById('infoMedia');
    container.innerHTML = '';
    mediaUrls.forEach(url => {
      url = url.trim();
      if (!url) return;
      const videoEmbed = generateVideoEmbed(url);
      if (videoEmbed) {
        container.insertAdjacentHTML('beforeend', videoEmbed);
      } else if (/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(url)) {
        // –ü—Ä—è–º–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        const img = document.createElement('img');
        img.src = url;
        img.alt = '–§–æ—Ç–æ';
        container.appendChild(img);
      } else {
        // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç - –≤—ã–≤–µ–¥–µ–º —Å—Å—ã–ª–∫—É
        const link = document.createElement('a');
        link.href = url;
        link.textContent = url;
        link.target = '_blank';
        container.appendChild(link);
      }
    });
  }

  // ----------------
  // –†–∞–±–æ—Ç–∞ —Å —Ñ–æ—Ä–º–æ–π
  // ----------------

  const form = document.getElementById('markerForm');
  const placeNameInput = document.getElementById('placeName');
  const visitDateInput = document.getElementById('visitDate');
  const commentInput = document.getElementById('comment');
  const markerTypeSelect = document.getElementById('markerType');
  const mediaContainer = document.getElementById('mediaContainer');
  const mediaUrlInput = document.getElementById('mediaUrlInput');
  const addMediaBtn = document.getElementById('addMediaBtn');
  const saveBtn = document
