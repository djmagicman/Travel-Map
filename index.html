<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Карта после входа</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
  #authContainer, #mainContainer { max-width: 400px; margin: 30px auto; }
  #mainContainer { display: none; height: 80vh; }
  #map { height: 100%; }
  input, button { display: block; width: 100%; margin: 10px 0; padding: 10px; font-size: 16px; }
  #logoutBtn { margin-top: 10px; background: #d9534f; color: white; border: none; cursor: pointer; }
</style>
</head>
<body>

<div id="authContainer">
  <h2 id="authTitle">Вход</h2>
  <input type="tel" id="phoneInput" placeholder="Номер телефона" />
  <input type="password" id="passwordInput" placeholder="Пароль" />
  <button id="authBtn">Войти</button>
  <div id="authMessage" style="color:red;"></div>
  <div><a href="#" id="toggleAuth">Нет аккаунта? Зарегистрироваться</a></div>
</div>

<div id="mainContainer">
  <h2>Добро пожаловать, <span id="userPhone"></span>!</h2>
  <div id="map"></div>
  <button id="logoutBtn">Выйти</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // Пользователи и текущий пользователь из localStorage
  let users = JSON.parse(localStorage.getItem('users') || '[]');
  let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');

  // Элементы страницы
  const authContainer = document.getElementById('authContainer');
  const mainContainer = document.getElementById('mainContainer');
  const authTitle = document.getElementById('authTitle');
  const phoneInput = document.getElementById('phoneInput');
  const passwordInput = document.getElementById('passwordInput');
  const authBtn = document.getElementById('authBtn');
  const authMessage = document.getElementById('authMessage');
  const toggleAuth = document.getElementById('toggleAuth');
  const userPhoneSpan = document.getElementById('userPhone');
  const logoutBtn = document.getElementById('logoutBtn');

  let isLogin = true; // флаг переключения между входом и регистрацией
  let map; // переменная для карты Leaflet

  // Показать основной интерфейс (карту и кнопку выхода)
  function showMain() {
    authContainer.style.display = 'none';
    mainContainer.style.display = 'block';
    userPhoneSpan.textContent = currentUser.phone;
    initMap();
  }

  // Показать форму авторизации
  function showAuth() {
    authContainer.style.display = 'block';
    mainContainer.style.display = 'none';
    authMessage.textContent = '';
    phoneInput.value = '';
    passwordInput.value = '';
  }

  // Инициализация карты Leaflet
  function initMap() {
    if (map) return; // если карта уже создана, не создаём заново
    map = L.map('map').setView([55.75, 37.62], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
  }

  // Обработчик переключения между входом и регистрацией
  toggleAuth.addEventListener('click', e => {
    e.preventDefault();
    isLogin = !isLogin;
    if (isLogin) {
      authTitle.textContent = 'Вход';
      authBtn.textContent = 'Войти';
      toggleAuth.textContent = 'Нет аккаунта? Зарегистрироваться';
    } else {
      authTitle.textContent = 'Регистрация';
      authBtn.textContent = 'Зарегистрироваться';
      toggleAuth.textContent = 'Уже есть аккаунт? Войти';
    }
    authMessage.textContent = '';
  });

  // Обработчик кнопки Войти / Зарегистрироваться
  authBtn.addEventListener('click', () => {
    const phone = phoneInput.value.trim();
    const password = passwordInput.value.trim();
    authMessage.textContent = '';

    if (!phone || !password) {
      authMessage.textContent = 'Пожалуйста, введите номер телефона и пароль.';
      return;
    }

    if (isLogin) {
      // Вход
      const user = users.find(u => u.phone === phone && u.password === password);
      if (user) {
        currentUser = user;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        showMain();
      } else {
        authMessage.textContent = 'Неверный номер телефона или пароль.';
      }
    } else {
      // Регистрация
      if (users.find(u => u.phone === phone)) {
        authMessage.textContent = 'Пользователь с таким номером уже зарегистрирован.';
        return;
      }
      const newUser = { phone, password };
      users.push(newUser);
      localStorage.setItem('users', JSON.stringify(users));
      currentUser = newUser;
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      showMain();
    }
  });

  // Кнопка выхода
  logoutBtn.addEventListener('click', () => {
    currentUser = null;
    localStorage.removeItem('currentUser');
    showAuth();
  });

  // При загрузке проверяем сессию и показываем нужный интерфейс
  window.addEventListener('load', () => {
    if (currentUser) {
      showMain();
    } else {
      showAuth();
    }
  });
</script>

</body>
</html>
