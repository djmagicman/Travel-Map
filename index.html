<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Travel Map Social</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { height: 100vh; width: 100vw; }
    .form-popup, .trip-popup {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
      width: 300px;
    }
    input, textarea, select, button {
      display: block;
      margin-top: 8px;
      width: 100%;
    }
    .hint, .user-info, .footer-note, .profile-btn, .welcome, .friends-btn {
      position: absolute;
      background: rgba(255,255,255,0.8);
      padding: 8px 10px;
      border-radius: 8px;
      z-index: 1000;
      font-size: 14px;
    }
    .hint { top: 10px; right: 10px; }
    .welcome { top: 10px; left: 50%; transform: translateX(-50%); font-size: 18px; font-weight: bold; }
    .user-info { top: 50px; left: 10px; display: none; }
    .profile-btn { top: 10px; left: 10px; cursor: pointer; }
    .friends-btn { top: 50px; right: 10px; cursor: pointer; }
    .footer-note { bottom: 10px; left: 10px; font-size: 12px; }
    .media-preview img, .media-preview video { max-width: 100%; margin-top: 5px; display: block; position: relative; }
    .media-preview div { position: relative; display: inline-block; margin-top: 5px; }
    .media-preview button {
      position: absolute;
      top: 0;
      right: 0;
      background: rgba(255,0,0,0.7);
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
      padding: 2px 5px;
    }
    .chat-box {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: white;
      width: 250px;
      height: 300px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-messages { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; }
    .chat-input { display: flex; border-top: 1px solid #ccc; }
    .chat-input input { flex: 1; border: none; padding: 8px; }
    .chat-input button { border: none; background: #2196f3; color: white; padding: 8px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="form" class="form-popup">
    <h3>Добавить поездку</h3>
    <input id="placeName" placeholder="Название места" />
    <input id="visitDate" type="date" />
    <textarea id="comment" placeholder="Комментарий"></textarea>
    <select id="markerType">
      <option value="visited">Был</option>
      <option value="planned">Планирую</option>
    </select>
    <select id="markerColor">
      <option value="red">Красный</option>
      <option value="green">Зеленый</option>
      <option value="blue">Синий</option>
      <option value="yellow">Желтый</option>
      <option value="purple">Фиолетовый</option>
      <option value="orange">Оранжевый</option>
      <option value="brown">Коричневый</option>
      <option value="pink">Розовый</option>
      <option value="gray">Серый</option>
      <option value="black">Черный</option>
    </select>
    <input id="mediaInput" type="file" multiple accept="image/*,video/*" />
    <div id="mediaPreview" class="media-preview"></div>
    <p id="coordDisplay"></p>
    <p id="addressDisplay"></p>
    <button onclick="saveMarker()">Сохранить</button>
  </div>

  <script>
    let map = L.map('map').setView([55.751244, 37.618423], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    let markers = JSON.parse(localStorage.getItem('markers') || '[]');
    let currentEditIndex = null;

    function renderMarkers() {
      document.querySelectorAll('.leaflet-marker-icon').forEach(el => el.remove());
      markers.forEach((m, i) => {
        const icon = L.divIcon({
          className: '',
          html: `<div style="width:16px;height:16px;background:${m.color};border-radius:50%;border:2px solid white"></div>`
        });
        const marker = L.marker([m.lat, m.lng], { icon }).addTo(map);
        marker.on('click', () => openForm({ lat: m.lat, lng: m.lng }, m, i));
      });
    }

    map.on('click', (e) => {
      openForm(e.latlng);
    });

    function openForm(latlng, data = null, index = null) {
      const form = document.getElementById('form');
      form.style.display = 'block';
      form.dataset.lat = latlng.lat;
      form.dataset.lng = latlng.lng;
      currentEditIndex = index;
      document.getElementById('placeName').value = data?.name || '';
      document.getElementById('visitDate').value = data?.date || '';
      document.getElementById('comment').value = data?.comment || '';
      document.getElementById('markerType').value = data?.type || 'visited';
      document.getElementById('markerColor').value = data?.color || 'red';
      const preview = document.getElementById('mediaPreview');
      preview.innerHTML = '';
      (data?.media || []).forEach((file, idx) => {
        const div = document.createElement('div');
        const mediaEl = file.type.startsWith('image') ? document.createElement('img') : document.createElement('video');
        mediaEl.src = file.url;
        if (file.type.startsWith('video')) mediaEl.controls = true;
        const delBtn = document.createElement('button');
        delBtn.textContent = '×';
        delBtn.onclick = () => {
          data.media.splice(idx, 1);
          saveMarker();
        };
        div.appendChild(mediaEl);
        div.appendChild(delBtn);
        preview.appendChild(div);
      });
      document.getElementById('mediaInput').value = '';
      document.getElementById('coordDisplay').textContent = `Координаты: ${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}`;

      fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latlng.lat}&lon=${latlng.lng}&format=json`)
        .then(res => res.json())
        .then(data => {
          document.getElementById('addressDisplay').textContent = `Адрес: ${data.display_name}`;
        }).catch(() => {
          document.getElementById('addressDisplay').textContent = 'Адрес не найден';
        });
    }

    function saveMarker() {
      const lat = parseFloat(document.getElementById('form').dataset.lat);
      const lng = parseFloat(document.getElementById('form').dataset.lng);
      const name = document.getElementById('placeName').value.trim();
      const date = document.getElementById('visitDate').value;
      const comment = document.getElementById('comment').value.trim();
      const type = document.getElementById('markerType').value;
      const color = document.getElementById('markerColor').value;
      const newFiles = Array.from(document.getElementById('mediaInput').files).map(file => ({ url: URL.createObjectURL(file), type: file.type }));

      if (currentEditIndex !== null) {
        markers[currentEditIndex] = { ...markers[currentEditIndex], lat, lng, name, date, comment, type, color, media: markers[currentEditIndex].media.concat(newFiles) };
      } else {
        markers.push({ lat, lng, name, date, comment, type, color, media: newFiles });
      }

      localStorage.setItem('markers', JSON.stringify(markers));
      document.getElementById('form').style.display = 'none';
      renderMarkers();
    }

    renderMarkers();
  </script>
</body>
</html>
